<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>SQL Server Table Partitioning in Large Scale Data Warehouse 2 - Herman-blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Icaurs - Hexo Theme"><meta name="msapplication-TileImage" content="/img/favicon1.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Icaurs - Hexo Theme"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="This post is part 2, we are focusing on design and create data process to extract, transform and load  (ETL) big amount data into partitioned tables to be able to integrate to SSIS package then operat"><meta property="og:type" content="blog"><meta property="og:title" content="SQL Server Table Partitioning in Large Scale Data Warehouse 2"><meta property="og:url" content="https://blog.hermanteng.net/2020/12/26/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-2/"><meta property="og:site_name" content="Herman-blog"><meta property="og:description" content="This post is part 2, we are focusing on design and create data process to extract, transform and load  (ETL) big amount data into partitioned tables to be able to integrate to SSIS package then operat"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.hermanteng.net/img/partitionswitchribbon.webp"><meta property="article:published_time" content="2020-12-26T17:06:21.000Z"><meta property="article:modified_time" content="2021-11-27T22:41:43.851Z"><meta property="article:author" content="Herman Teng"><meta property="article:tag" content="SQL Server, partitioning"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/partitionswitchribbon.webp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.hermanteng.net/2020/12/26/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-2/"},"headline":"Herman-blog","image":[],"datePublished":"2020-12-26T17:06:21.000Z","dateModified":"2021-11-27T22:41:43.851Z","author":{"@type":"Person","name":"Herman Teng"},"description":"This post is part 2, we are focusing on design and create data process to extract, transform and load  (ETL) big amount data into partitioned tables to be able to integrate to SSIS package then operat"}</script><link rel="canonical" href="https://blog.hermanteng.net/2020/12/26/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-2/"><link rel="icon" href="/img/favicon1.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatar1.png" alt="Herman-blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/img/partitionswitchribbon.webp" alt="SQL Server Table Partitioning in Large Scale Data Warehouse 2"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-12-26T17:06:21.000Z" title="2020-12-26T17:06:21.000Z">2020-12-26</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-11-27T22:41:43.851Z" title="2021-11-27T22:41:43.851Z">2021-11-27</time></span><span class="level-item"><a class="link-muted" href="/categories/Database-BI/">Database, BI</a></span><span class="level-item">39 minutes read (About 5843 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">SQL Server Table Partitioning in Large Scale Data Warehouse 2</h1><div class="content"><p>This post is part 2, we are focusing on design and create data process to extract, transform and load  (ETL) big amount data into partitioned tables to be able to integrate to SSIS package then operate ETL process by scheduled job automatically. </p>
<p>In this case, we suppose transaction data with 100 columns and 100 million records need to be loaded into data warehouse from staging table. Technically, we can do partition switching from staging table (non partitioned table) to data warehouse table (partitioned table), but under the business reality, we can’t just simply do it like that, because</p>
<ol>
<li>Source table and target table usually are in different database, it’s not able to switch data directly because of violating same file group condition by partition switching basic in part 1. </li>
<li>Staging table would be empty after partition switching, but the most of data transformations are applied to staging table then load final results into target table in data warehouse, so in business point of view, we can’t do partition switching from staging to target neither because big impact for entire daily, weekly or monthly data process.</li>
</ol>
<p>There might be another question: why don’t we bulk load data from source to target or what benefits do we get from partition switching? Technically, yes, we can do bulk insert, however, for such big volume of data  movement, the lead time is going to be hours (2-3 hours), if the process ran on business hours, it would cause big impact and it’s hard to tolerant by business users for critical data like transaction so from efficiency and performance perspective,  we have to leverage partition switching to deliver transaction data in short period of time without interrupt BI reports, dashboard refresh and business analysis.</p>
<h2 id="What-is-the-main-idea-for-production-operation"><a href="#What-is-the-main-idea-for-production-operation" class="headerlink" title="What is the main idea for production operation?"></a>What is the main idea for production operation?</h2><p>In order to promise transaction data is always available, we need to create a middle table to hold transaction data as source table for partition switching, we call that middle table as switch table. To satisfy all the requirements for partition switching, the switch table has to be created in as the same file group as target transaction table, identical columns, indexes, use the same partition column. We do the bulk insert from staging table to switch table then partition switch to target transaction table in data warehouse, as part 1 mentioned, this step will finish in flash as long as there is no blocking. At last, we drop switch table so the entire data process completes. Now let’s dig litter deeper on details for each steps.</p>
<a id="more"></a>

<p><img src="/img/screenshots/partitionSwitchiingWorkflow.png" alt="partitionSwitchiingWorkflow.png"></p>
<h2 id="Create-switch-table-task"><a href="#Create-switch-table-task" class="headerlink" title="Create switch table task"></a>Create switch table task</h2><p>From part 1 table partitioning basics, we know to create partition table we need to create partition function then partition schemes to associate with partition functions, and also need to replicate all indexes from target table such as cluster index and non cluster columnstore index. To be able to let us code more reusable, we’d better encapsulate those functions into stored procedures then create a single script to call those stored procedures to finish the task.</p>
<h3 id="Create-partition-function-and-scheme-for-switch-table"><a href="#Create-partition-function-and-scheme-for-switch-table" class="headerlink" title="Create partition function and scheme for switch table"></a>Create partition function and scheme for switch table</h3><p>Before we jump to the code some condition need to be clarified there:</p>
<ul>
<li>Transaction table is partitioned by month</li>
<li>Partition column is <code>month_key</code> which is 6 digit integer like 202010 (Oct, 2020), 202011 (Nov, 2020)</li>
<li>Target table file group naming convention: [database name]_FG_[table name]_[year]</li>
<li>Partition function naming convention: [database name]_PF_[table name]</li>
<li>Partition scheme naming convention: [database name]_PS_[table name]</li>
<li>Cluster indexes naming convention: PK_[table name]</li>
<li>Non cluster columnstore index naming convention: CSI_[table name]</li>
</ul>
<p>Now, we are ready to create stored procedure to generate partition function and scheme for switch table:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> dbo.usp_makePartitionOnTable</span><br><span class="line"> @table_name <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="comment">--target (structure source) table name</span></span><br><span class="line">,@created_table_name <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="comment">--switch table name</span></span><br><span class="line">,@lrang <span class="built_in">int</span> <span class="comment">--left range</span></span><br><span class="line">,@rrang <span class="built_in">int</span> <span class="comment">--right range</span></span><br><span class="line">,@partition_col <span class="built_in">varchar</span>(<span class="number">100</span>) = <span class="string">&#x27;month_key&#x27;</span></span><br><span class="line">,@dbname <span class="built_in">varchar</span>(<span class="number">100</span>) = <span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> @sp_msg <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line"><span class="comment">--check input parameter value, can&#x27;t be &#x27;&#x27; or NULL</span></span><br><span class="line"><span class="keyword">set</span> @table_name = <span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@table_name))</span><br><span class="line"><span class="keyword">if</span> (@table_name = <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @table_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">set</span> @sp_msg = <span class="string">&#x27;@table_name is empty,check input value&#x27;</span></span><br><span class="line">	<span class="keyword">goto</span> errorProc <span class="comment">--error capture block</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @created_table_name = <span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@created_table_name))</span><br><span class="line"><span class="keyword">if</span> (@created_table_name = <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @created_table_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">set</span> @sp_msg = <span class="string">&#x27;@create_table_name is empty, check input value&#x27;</span></span><br><span class="line">	<span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @lrang = <span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@lrang))</span><br><span class="line"><span class="keyword">if</span> (@lrang = <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @lrang <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">set</span> @sp_msg = <span class="string">&#x27;@lrang is empty, check input value&#x27;</span></span><br><span class="line">	<span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @rrang = <span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@rrang))</span><br><span class="line"><span class="keyword">if</span> (@rrang = <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @rrang <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">set</span> @sp_msg = <span class="string">&#x27;@rrang is empty, check input value&#x27;</span></span><br><span class="line">	<span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span>	</span><br><span class="line"><span class="keyword">if</span> (@rrange &lt; <span class="number">100000</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">set</span> @sp_msg = <span class="string">&#x27;the boundary is out of range, check input value&#x27;</span></span><br><span class="line">	<span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span>	</span><br><span class="line"><span class="keyword">declare</span> @sSQ <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">,@iRange <span class="built_in">int</span></span><br><span class="line">,@pfName <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="comment">--partition function</span></span><br><span class="line">,@srcpfName <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="comment">--target table partition function</span></span><br><span class="line">,@filegropus <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">,@psName <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@filegroup_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@param <span class="built_in">varchar</span>(<span class="number">200</span>)</span><br><span class="line">,@minrange <span class="built_in">int</span></span><br><span class="line">,@maxrange <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @pfName = @dbname+<span class="string">&#x27;_PF_&#x27;</span>+@created_table_name</span><br><span class="line"><span class="keyword">set</span> @srcpfName = @dbname+<span class="string">&#x27;PF&#x27;</span>+@table_name</span><br><span class="line"><span class="comment">--check if partition function exists, if not, create, if so drop for rerun</span></span><br><span class="line"><span class="keyword">declare</span> @<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>),@<span class="keyword">year</span> <span class="built_in">int</span></span><br><span class="line"><span class="keyword">set</span> @sSQL = <span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; if(exists(select name from sys.objects where </span></span><br><span class="line"><span class="string">OBJECT_NAME(OBJECT_ID)=&#x27;&#x27;&#x27;</span>+@created_table_name+<span class="string">&#x27;&#x27;&#x27; and type in (&#x27;&#x27;U&#x27;&#x27;)))&#x27;</span> +</span><br><span class="line"><span class="string">&#x27;drop table dbo.&#x27;</span>+@created_table_name</span><br><span class="line">print @sSQL</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="comment">--check partition scheme</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+ <span class="string">&#x27;; select @name=PS.name from &#x27;</span>+@dbname+<span class="string">&#x27;.sys.partition_schemes as PS</span></span><br><span class="line"><span class="string">inner join &#x27;</span>+@dbname+<span class="string">&#x27;.sys.partition_functions as PF on PF.function_id=PS.function_id&#x27;</span>+<span class="string">&#x27;</span></span><br><span class="line"><span class="string">where PF.name=&#x27;&#x27;&#x27;</span>+@pfName+<span class="string">&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">print @sSQL</span><br><span class="line">exec sp_executeSQL @sSQL, <span class="string">&#x27;@name varchar(100) output&#x27;</span>, @<span class="keyword">name</span>=@spName <span class="keyword">output</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(@psName != <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL = <span class="string">&#x27;use &#x27;</span>+@dbname+ <span class="string">&#x27;; drop partition scheme &#x27;</span>+@psName</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--check partition function</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">name</span>=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; select @name=name from &#x27;</span>+@dbname+<span class="string">&#x27;.sys.partition_functions where</span></span><br><span class="line"><span class="string">name=&#x27;&#x27;&#x27;</span>+@pfName+<span class="string">&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">print @sSQL</span><br><span class="line">exec sp_executeSQL @sSQL <span class="string">&#x27;@name varchar(100) output&#x27;</span>, @<span class="keyword">name</span>=@<span class="keyword">name</span> <span class="keyword">output</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(@<span class="keyword">name</span> != <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL = <span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; drop partition function &#x27;</span>+@pfName</span><br><span class="line">print @sSQL</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--create partition function</span></span><br><span class="line"><span class="comment">--check if lrange is in the lrange for the src table, and rrange is in the rrange. otherwise,</span></span><br><span class="line"><span class="comment">--add one more in left and one more in right</span></span><br><span class="line"><span class="keyword">if</span>(@created_table_name&lt;&gt;@table_name)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; select @lrange=convert(int,min(prv.value)), @rrange=convert(int,max(pre.value))&#x27;</span>+</span><br><span class="line"><span class="string">&#x27; from sys.partition_range_values as prv join sys.partition_functions as pfs&#x27;</span>+</span><br><span class="line"><span class="string">&#x27; on prv.function_id=pfs.function_id &#x27;</span>+</span><br><span class="line"><span class="string">&#x27; where pfs.name=&#x27;&#x27;&#x27;</span>+@srcpfName+<span class="string">&#x27;&#x27;&#x27; &#x27;</span></span><br><span class="line"><span class="keyword">set</span> @param = <span class="string">&#x27;@lrange int output, @rrange int output&#x27;</span></span><br><span class="line">print @sSQL</span><br><span class="line">exec sp_executeSQL @sSQL, @param, @lrange=minrange <span class="keyword">output</span>, @rrange=@maxrange <span class="keyword">output</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @minrange=<span class="number">0</span></span><br><span class="line"><span class="keyword">set</span> @maxrange=<span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>(@lrange&gt;@minrange <span class="keyword">and</span> @rrange&lt;@maxrange)<span class="comment">--check the input parameter value if fall in the right range</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--month_key calculate for Jan for lrange</span></span><br><span class="line"><span class="keyword">if</span>(@lrange%<span class="number">100</span>=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">set</span> iRange = @lrange<span class="number">-89</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @iRange = @lrange<span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @iRange = @lrange <span class="comment">--set default value for @iRange</span></span><br><span class="line"><span class="keyword">if</span>(@rrange&lt;=@maxrange)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">if</span>(@rrange%<span class="number">100</span>=<span class="number">12</span>)</span><br><span class="line"><span class="keyword">set</span> @rrange=@rrange+<span class="number">89</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @rrange=@rrange+<span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @filegroups=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;;&#x27;</span>+</span><br><span class="line"><span class="string">&#x27;create partition function &#x27;</span>+@pfName+<span class="string">&#x27;(int) as range left for values(&#x27;</span></span><br><span class="line"><span class="keyword">while</span>(@iRange&lt;=@rrange)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @filegroup_name=@dbname+<span class="string">&#x27;_FG_&#x27;</span>+@table_name+<span class="string">&#x27;_&#x27;</span>+<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">4</span>),@<span class="keyword">year</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">convert</span>(<span class="built_in">int</span>, <span class="keyword">right</span>(<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">6</span>),@iRange),<span class="number">2</span>))=<span class="number">12</span>)</span><br><span class="line"><span class="keyword">set</span> @iRange=(<span class="keyword">convert</span>(<span class="built_in">int</span>,<span class="keyword">left</span>(<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">6</span>),@iRange),<span class="number">4</span>))+<span class="number">1</span>)*<span class="number">100</span>+<span class="number">1</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @iRange+=<span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--last boundary</span></span><br><span class="line"><span class="keyword">if</span>(@iRange&gt;@rrange)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27;)&#x27;</span></span><br><span class="line"><span class="keyword">set</span> @filegroups=@filegroups+@filegroup_name+<span class="string">&#x27;)&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27;,&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">print @sSQL</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="comment">--create partition scheme</span></span><br><span class="line"><span class="keyword">set</span> @psName=@dbname+<span class="string">&#x27;_PS_&#x27;</span>+@created_table_name</span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; &#x27;</span>+</span><br><span class="line"><span class="string">&#x27;create partition scheme &#x27;</span>+@psName+</span><br><span class="line"><span class="string">&#x27;as partition &#x27;</span>+@pfName+</span><br><span class="line"><span class="string">&#x27; to (&#x27;</span>+@filegroups</span><br><span class="line"></span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--add some try catch statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--add some error catch statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Replicate-target-table-structure-column-and-data-type-for-switch-table"><a href="#Replicate-target-table-structure-column-and-data-type-for-switch-table" class="headerlink" title="Replicate target table structure (column and data type) for switch table"></a>Replicate target table structure (column and data type) for switch table</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> dbo.usp_getTableModel</span><br><span class="line">(</span><br><span class="line">	@dbName <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">    ,@table_name <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">    ,@create_table <span class="keyword">as</span> varcahr(<span class="number">100</span>)</span><br><span class="line">    ,@sSQL <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="keyword">max</span>) <span class="keyword">output</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> @colTemp <span class="keyword">as</span> <span class="keyword">table</span></span><br><span class="line">(</span><br><span class="line">	<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">    ,seqNo <span class="built_in">int</span></span><br><span class="line">    ,IsNullable <span class="built_in">bit</span></span><br><span class="line">    ,col_def <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">    ,data_type <span class="built_in">varchar</span>(<span class="number">128</span>)</span><br><span class="line">    ,char_len <span class="built_in">int</span></span><br><span class="line">    ,num_precs <span class="built_in">int</span></span><br><span class="line">    ,num_dec <span class="built_in">int</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">set</span> @sSQL = <span class="string">&#x27;</span></span><br><span class="line"><span class="string">select ltrim(rtrim(column_name)) as name</span></span><br><span class="line"><span class="string">,ordinal_position as seqNo</span></span><br><span class="line"><span class="string">,case when ltrim(rtrim(is_nullable))=&#x27;&#x27;no&#x27;&#x27; then 1 else 0 end as IsNullable</span></span><br><span class="line"><span class="string">,ltrim(rtrim(column_default)) as col_def</span></span><br><span class="line"><span class="string">,upper(ltrim(rtrim(data_type))) as data_type</span></span><br><span class="line"><span class="string">,character_maximum_length as char_len</span></span><br><span class="line"><span class="string">,numeric_precision as num_precs</span></span><br><span class="line"><span class="string">,numeric_scale as num_dec</span></span><br><span class="line"><span class="string">from &#x27;</span>+@dbname+<span class="string">&#x27;.information_schema.columns</span></span><br><span class="line"><span class="string">where table_name=@table_name and table_catalog=@dbname&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> @colTemp</span><br><span class="line">exec sp_executeSQL @sSQL, <span class="string">&#x27;@table_name varchar(100),@dbname varchar(100)&#x27;</span></span><br><span class="line">,@table_name=@table_name,@dbname=@dbname</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> @i <span class="built_in">int</span></span><br><span class="line">,@<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@seqNo <span class="built_in">int</span></span><br><span class="line">,@<span class="keyword">IsNull</span> <span class="built_in">int</span></span><br><span class="line">,@col_def <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">,@data_type <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@char_len <span class="built_in">int</span></span><br><span class="line">,@num_precs <span class="built_in">int</span></span><br><span class="line">,@num_dec <span class="built_in">int</span></span><br><span class="line">,@maxcount <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> @maxcount = <span class="keyword">max</span>(seqNo) <span class="keyword">from</span> @colTemp</span><br><span class="line">;</span><br><span class="line"><span class="keyword">select</span> @i=<span class="keyword">min</span>(seqNo) <span class="keyword">from</span> @colTemp</span><br><span class="line">;</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">@<span class="keyword">name</span>=<span class="keyword">name</span></span><br><span class="line">,@seqNo=seqNo</span><br><span class="line">,@<span class="keyword">IsNull</span>=IsNullable</span><br><span class="line">,@col_def=col_def</span><br><span class="line">,@data_type=data_typ</span><br><span class="line">,@char_len=char_len</span><br><span class="line">,@num_precs=num_precs</span><br><span class="line">,@num_dec=num_dec</span><br><span class="line"><span class="keyword">from</span> @colTemp</span><br><span class="line"><span class="keyword">where</span> seqNo=@i</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;create table &#x27;</span>+<span class="keyword">quotename</span>(@dbname)+<span class="string">&#x27;.dbo.&#x27;</span>+<span class="keyword">quotename</span>(@created_table) +<span class="string">&#x27;(&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> @i <span class="keyword">is</span> <span class="literal">Null</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL = @sSQL + @<span class="keyword">Name</span></span><br><span class="line"><span class="keyword">set</span> @sSQL = @sSQL+<span class="string">&#x27; &#x27;</span>+@data_type</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">charindex</span>(<span class="string">&#x27;char&#x27;</span>,<span class="keyword">lower</span>(@date_type))&gt;<span class="number">0</span> <span class="keyword">or</span> <span class="keyword">charindex</span>(<span class="string">&#x27;var&#x27;</span>,lover(@data_type))&gt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">set</span>  @sSQL=@sSQL+<span class="string">&#x27;(&#x27;</span>+<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(<span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">4</span>),@char_len)))+<span class="string">&#x27;)&#x27;</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">charindex</span>(<span class="string">&#x27;decimal&#x27;</span>,<span class="keyword">lower</span>(@data_type))&gt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL = @sSQL+<span class="string">&#x27;(&#x27;</span>+<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(<span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">4</span>),@num_precs)))+<span class="string">&#x27;,&#x27;</span>+</span><br><span class="line"><span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(<span class="keyword">convert</span>(<span class="number">4</span>),@num_dec)))+<span class="string">&#x27;)&#x27;</span></span><br><span class="line"><span class="keyword">if</span>(@col_def&lt;&gt;<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27; &#x27;</span>+<span class="string">&#x27;default &#x27;</span>+@col_def</span><br><span class="line"><span class="keyword">if</span>(@<span class="keyword">IsNull</span>=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27; Null&#x27;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27; not Null&#x27;</span></span><br><span class="line"><span class="keyword">if</span>(@i&lt;@maxcount)</span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27;,&#x27;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27;)&#x27;</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> @colTemp</span><br><span class="line"><span class="keyword">where</span> seqNo=@i</span><br><span class="line"><span class="keyword">select</span> @i=<span class="keyword">min</span>(seqNo) <span class="keyword">from</span> @colTemp</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">@<span class="keyword">name</span>=<span class="keyword">name</span></span><br><span class="line">,@seqNo=seqNo</span><br><span class="line">,@<span class="keyword">IsNull</span>=IsNullable</span><br><span class="line">,@col_def=col_def</span><br><span class="line">,@data_type=data_typ</span><br><span class="line">,@char_len=char_len</span><br><span class="line">,@num_precs=num_precs</span><br><span class="line">,@num_dec=num_dec</span><br><span class="line"><span class="keyword">from</span> @colTemp</span><br><span class="line"><span class="keyword">where</span> seqNo=@i</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<h3 id="Replicate-target-table-cluster-index-for-switch-table"><a href="#Replicate-target-table-cluster-index-for-switch-table" class="headerlink" title="Replicate target table cluster index for switch table"></a>Replicate target table cluster index for switch table</h3><p>we also need to clone cluster index from src (target) to switch table</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> dbo.usp_ReplicateClusterIndex @table_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@created_table <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@dbname <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> @i <span class="built_in">int</span></span><br><span class="line">,@sSQL <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">,@ncount <span class="built_in">int</span></span><br><span class="line">,@colname <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@nloop <span class="built_in">int</span></span><br><span class="line">,@return_result <span class="built_in">int</span></span><br><span class="line">,@sp_msg <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">set</span> @table_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@table_name))</span><br><span class="line"><span class="keyword">if</span>(@table_name=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @table_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sp_msg=<span class="string">&#x27;ended with @table_name empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">declare</span> @<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="comment">--find out if the object exists</span></span><br><span class="line"><span class="keyword">set</span> @sSQL = <span class="string">&#x27;use &#x27;</span>+@dbname+ <span class="string">&#x27;; select @name=name from sys.indexes where</span></span><br><span class="line"><span class="string">name=&#x27;&#x27;PK_&#x27;</span>+@created_table+<span class="string">&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">exec sp_executeSQL @sSQL, <span class="string">&#x27;@name varchar(100) output&#x27;</span>, @<span class="keyword">name</span>=@<span class="keyword">name</span> <span class="keyword">output</span></span><br><span class="line"><span class="keyword">if</span> @<span class="keyword">name</span> != <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; drop index PK_&#x27;</span>+@created_table+<span class="string">&#x27; on dbo.&#x27;</span>+@created_table</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span> (@<span class="keyword">name</span>=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @<span class="keyword">name</span> <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> @tblcol <span class="keyword">table</span>(colID <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>, colNmae <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; select b._key,&#x27;&#x27;[&#x27;&#x27;+c.name+&#x27;&#x27;]&#x27;&#x27;</span></span><br><span class="line"><span class="string">from sys.indexes a join sys.index_columns b on a.object_id=b.object_id</span></span><br><span class="line"><span class="string">and a.index_id=b.index_id</span></span><br><span class="line"><span class="string">join sys.columns c on b.column_id=c.column_id and b.object_id=c.object_id</span></span><br><span class="line"><span class="string">where a.name=&#x27;&#x27;PK_&#x27;</span>+@table_name+<span class="string">&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> @tblCol</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">select</span> @ncount=<span class="keyword">count</span>(*) <span class="keyword">from</span> @tblcol;</span><br><span class="line"><span class="keyword">select</span> @i=<span class="keyword">min</span>(colID) <span class="keyword">from</span> @tblcol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> nloop=o</span><br><span class="line"><span class="keyword">set</span> @sSQL = <span class="string">&#x27;use &#x27;</span>+@dbname+ <span class="string">&#x27;; create clustered index PK_&#x27;</span>+@created_table+<span class="string">&#x27; on &#x27;</span>+<span class="keyword">quotename</span>(@created_table)+<span class="string">&#x27;(&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> @i <span class="keyword">is</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">select</span> @colName=colName <span class="keyword">from</span> @tblcol <span class="keyword">where</span> colID=@i</span><br><span class="line"><span class="keyword">if</span>(@nloop=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+@colName</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27;, &#x27;</span>+@colName</span><br><span class="line"><span class="keyword">set</span> @nloop+=<span class="number">1</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> @tblcol <span class="keyword">where</span> colID=@i</span><br><span class="line"><span class="keyword">set</span> @i=<span class="keyword">min</span>(colID) <span class="keyword">from</span> @tblcol</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27;)&#x27;</span></span><br><span class="line">exec @return_result=sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">if</span>(return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--try catch block statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--error log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Create-partitioned-switch-table"><a href="#Create-partitioned-switch-table" class="headerlink" title="Create partitioned switch table"></a>Create partitioned switch table</h3><p>Now we have all store procedures to meet partitioned table requirement, it’s time to create a script (store procedure) to integrate in order to create partitioned switch table.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> dbo.usp_createPartitionTable @table_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@partition_col <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;month_key&#x27;</span></span><br><span class="line">,@created_table <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@lrange <span class="built_in">int</span></span><br><span class="line">,@rrange <span class="built_in">int</span></span><br><span class="line">,@dbname <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> nocount <span class="keyword">on</span>;</span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> @return_result <span class="built_in">int</span></span><br><span class="line">,@sSQL <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">,sp_msg <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">set</span> @table_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@table_name))</span><br><span class="line"><span class="keyword">if</span>(@table_name =<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @table_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sp_msg=<span class="string">&#x27;end with @table_name is empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @created_table =<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@created_table))</span><br><span class="line"><span class="keyword">if</span>(@created_table=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @created_table <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sp_msg=<span class="string">&#x27;end with @created_table is empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>(@lrange <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end with @lrange empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>(@rrange <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end with @rrange empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">declare</span> @<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>),@ps_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;select @name=name from &#x27;</span>+<span class="keyword">quotename</span>(@dbname)+<span class="string">&#x27;.sys.tables where name=&#x27;&#x27;&#x27;</span>+@created_table<span class="string">&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">print @sSQL</span><br><span class="line">exec sp_executeSQL @sSQL, <span class="string">&#x27;@name varchar(100) output&#x27;</span>, @<span class="keyword">name</span>=@<span class="keyword">name</span> <span class="keyword">output</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(@<span class="keyword">name</span> !=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;drop table &#x27;</span>+<span class="keyword">quotename</span>(@dbname)+<span class="string">&#x27;.dbo.&#x27;</span>+@created_table</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--create partition function and scheme</span></span><br><span class="line">exec business_db.dbo.usp_makePartitionOnTable @table_name=@table_name</span><br><span class="line">,@created_table_name=@created_table</span><br><span class="line">,@lrange=@lrange</span><br><span class="line">,@rrange=@rrange</span><br><span class="line">,@partiton_col=@partition_col</span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="comment">--create swich table structure</span></span><br><span class="line">exec business_db.dbo.usp_getTableModel @dbname=@dbname</span><br><span class="line">,@table_name=@table_name</span><br><span class="line">,@created_table=@created_table</span><br><span class="line">,@sSQL=@sSQL <span class="keyword">output</span></span><br><span class="line"><span class="keyword">set</span> @ps_name=@dbname+<span class="string">&#x27;_PS_&#x27;</span>+@created_table</span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;;&#x27;</span>+@sSQL+<span class="string">&#x27; on &#x27;</span>+@ps_name+<span class="string">&#x27;(&#x27;</span>+@partition_col+<span class="string">&#x27;)&#x27;</span></span><br><span class="line">print @sSQL</span><br><span class="line">exec sp_executedSQL @sSQL</span><br><span class="line"><span class="comment">--create cluster index for switch table</span></span><br><span class="line">exec @return_result=business_db.dbo.usp_ReplicateClusterIndex @table_name=@table_name</span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--add try catch block statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--add some error handling statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Business-data-API"><a href="#Business-data-API" class="headerlink" title="Business data API"></a>Business data API</h3><p>We have everything to create a partitioned table so far, the only thing left is create a data API to pass in input value in terms of business RSD (Requirement Specifics document).</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> switch_transaction</span><br><span class="line"><span class="keyword">as</span> </span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> @left_range <span class="built_in">int</span></span><br><span class="line">,@right_range <span class="built_in">int</span></span><br><span class="line">,@return_result <span class="built_in">int</span></span><br><span class="line"><span class="keyword">select</span> top <span class="number">1</span> @left_range=month_key <span class="keyword">from</span> staging.dbo.transaction</span><br><span class="line">exec @return_result=business_db.dbo.usp_createPartitionTable @table_name=<span class="string">&#x27;transaction&#x27;</span></span><br><span class="line">,@partition_col=<span class="string">&#x27;month_key&#x27;</span></span><br><span class="line">,@created_table=<span class="string">&#x27;switch_transaction&#x27;</span></span><br><span class="line">,@lrange=@left_range</span><br><span class="line">,@rrange=@left_range</span><br><span class="line">,@dbname=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">if</span>(return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="Load-staging-transaction-data-into-switch-table"><a href="#Load-staging-transaction-data-into-switch-table" class="headerlink" title="Load staging transaction data into switch table"></a>Load staging transaction data into switch table</h2><p>This step, we need to prepare data for switch table in order to make partition switching later on. Because switch table is a kind of temp table and it’s not awareness by business data users, so no matter how long the loading time is, it won’t cause down time on production. For the bulk insert, the simplest and fastest way is use SSIS <code>data flow</code> which provides bulk load functionality.</p>
<p><img src="/img/screenshots/dataflowstaging2switch.png" alt="dataflowstaging2switch.png"></p>
<p><img src="/img/screenshots/targetLoadFn.png" alt="targetLoadFn.png"></p>
<p>for <code>Data access mode</code> option, there is drop-down list, make sure <strong>Table or view - fast load</strong> being selected.</p>
<h2 id="Create-columnstore-index-for-switch-table"><a href="#Create-columnstore-index-for-switch-table" class="headerlink" title="Create columnstore index for switch table"></a>Create columnstore index for switch table</h2><p>In this step, we create columnstore index for switch table, you might ask why we don’t create it along with cluster index prior data loading? We separate columnstore index from cluster index is by its special properties, because we can’t load data with columnstore index enabled. Now let’s brief take a look at the definition by Microsoft</p>
<blockquote>
<p>Columnstore indexes are the standard for storing and querying large data warehousing fact tables. This index uses column-based data storage and query processing to achieve gains up to 10 times the query performance in your data warehouse over traditional row-oriented storage. You can also achieve gains up to 10 times the data compression over the uncompressed data size. Beginning with SQL Server 2016 SP1, columnstore indexes enable operational analytics: the ability to run performant real-time analytics on a transactional workload.</p>
<p>A columnstore index is a technology for storing, retrieving, and managing data by using a columnar data format, called a <strong><em>columnstore</em></strong></p>
</blockquote>
<p>Obviously, we can gain a lot of performance benefits from <code>columnstore</code> index, but its specialty decides we have to treat it very carefully, because it costs a quite long time to build it for large data warehousing fact table.</p>
<p>we are going to create a stored procedure to achieve the function of building columnstore index then write another API to create columnstore index for switch table in terms of business requirement.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> usp_createColmart @table_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@src_table <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="comment">--target table </span></span><br><span class="line">,@dbname <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> @i <span class="built_in">int</span></span><br><span class="line">,@sSQL <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">,@ncount <span class="built_in">int</span></span><br><span class="line">,@colName <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@nloop <span class="built_in">int</span></span><br><span class="line">,@return_result <span class="built_in">int</span></span><br><span class="line">,@sp_msg <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">set</span> @table_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@table_name))</span><br><span class="line"><span class="keyword">if</span>(@table_name=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @table_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end with @table_name is empty, check the input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @dbname=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@dbname))</span><br><span class="line"><span class="keyword">declare</span> @<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; select @name=name from sys.indexes where name=&#x27;&#x27;CSI_&#x27;</span>+@table_name+<span class="string">&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">exec sp_executeSQL @sSQL, <span class="string">&#x27;@name varchar(100) output&#x27;</span>, @<span class="keyword">name</span>=@<span class="keyword">name</span> <span class="keyword">output</span></span><br><span class="line"><span class="keyword">if</span>(@<span class="keyword">name</span> !=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; drop index CSI_&#x27;</span>+@table_name+<span class="string">&#x27; on dbo.&#x27;</span>+@table_name</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">declare</span> @tblcol <span class="keyword">table</span>(colID <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>, colName <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; select c.column_id,c.name from sys.indexes a</span></span><br><span class="line"><span class="string">inner join sys.index_columns b on a.object_id=b.object_id and a.index_id=b.index_id</span></span><br><span class="line"><span class="string">inner join sys.columns c on b.object_id=c.object_id and b.column_id=c.column_id</span></span><br><span class="line"><span class="string">where a.is_primary_key=0 and</span></span><br><span class="line"><span class="string">a.is_unique=0 and</span></span><br><span class="line"><span class="string">a.is_unique_constraint=0 and</span></span><br><span class="line"><span class="string">a.name=&#x27;&#x27;CSI_&#x27;</span>+@scr_table+<span class="string">&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> @tblcol</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">select</span> @ncount=<span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">from</span> @tblcol</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @nloop=<span class="number">0</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; create nonclustered columnstore index CSI_&#x27;</span>+@table_name+<span class="string">&#x27; on &#x27;</span>+</span><br><span class="line"><span class="keyword">quotename</span>(@table_name)+<span class="string">&#x27;(&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> @i <span class="keyword">is</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">select</span> @colName=colName <span class="keyword">from</span> @tblcol <span class="keyword">where</span> colID=@i</span><br><span class="line"><span class="keyword">if</span>(@nloop=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL = @sSQL + @colName</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27;,&#x27;</span>+@colName</span><br><span class="line"><span class="keyword">set</span> nloop+=<span class="number">1</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> @tblcol <span class="keyword">where</span> colID=@i</span><br><span class="line"><span class="keyword">select</span> @i=<span class="keyword">min</span>(colID) <span class="keyword">from</span> @tblcol</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @sSQL+=<span class="string">&#x27;)&#x27;</span></span><br><span class="line">exec @return_result=sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--add try catch block statment</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--error handling statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Now, we create business data API to pass in parament value based on business requirement, in this case, we deal with transaction table</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> switch_transaction_csi</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> @left_range <span class="built_in">int</span></span><br><span class="line">,@right_range <span class="built_in">int</span></span><br><span class="line">,@return_result <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">exec @return_result=business_db.dbo.usp_createColmart @table_name=<span class="string">&#x27;switch_transaction&#x27;</span></span><br><span class="line">,@scr_table=<span class="string">&#x27;transaction&#x27;</span></span><br><span class="line">,@dbname=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--add try catch block statment</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--error handling statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="Partition-switching-to-load-data-to-target-table"><a href="#Partition-switching-to-load-data-to-target-table" class="headerlink" title="Partition switching to load data to target table"></a>Partition switching to load data to target table</h2><p>So far we create switch table and load transaction data into it then create <code>columnstore</code> index, next we are going to conduct major task to switch partition from switch table to target transaction table. For code reusable and more generic scenarios, we still need do some condition checks before we jump to partition switching.</p>
<h3 id="Check-data-in-switch-staging-table-is-in-the-right-range-and-ready-to-be-proceeded"><a href="#Check-data-in-switch-staging-table-is-in-the-right-range-and-ready-to-be-proceeded" class="headerlink" title="Check data in switch (staging) table is in the right range and ready to be proceeded"></a>Check data in switch (staging) table is in the right range and ready to be proceeded</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> usp_IsStgDataReady</span><br><span class="line">(</span><br><span class="line">	@stgtbl_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">    ,@partition_col <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;month_key&#x27;</span></span><br><span class="line">    ,@lrange <span class="built_in">int</span></span><br><span class="line">    ,@urange <span class="built_in">int</span></span><br><span class="line">    ,@dbname <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> @sSQL <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">,@month_key <span class="built_in">int</span></span><br><span class="line">,@sParam <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@<span class="keyword">range</span> <span class="built_in">int</span></span><br><span class="line">,@sp_msg <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @stgtbl_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@stgtbl_name))</span><br><span class="line"><span class="keyword">if</span>(@stgtbl_name=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @stgtbl_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end up with @stgtbl_name empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @partition_col=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@partition_col))</span><br><span class="line"><span class="keyword">if</span>(@partition_col=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @partition_col <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sp_msg=<span class="string">&#x27;end up with @partition_col empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">not</span> <span class="keyword">len</span>(<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">6</span>),@urange))=<span class="number">6</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end up with @urange is out of range, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">range</span>=@lrange</span><br><span class="line"><span class="keyword">while</span> @<span class="keyword">range</span> &lt;= @urange</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sParam=<span class="string">&#x27;@month_keyOut int output&#x27;</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;select top 1 @month_keyOut=&#x27;</span>+@partition_col+</span><br><span class="line"><span class="string">&#x27; from&#x27;</span>+@dbname+<span class="string">&#x27;.dbo.&#x27;</span>+@stgtbl_name+<span class="string">&#x27;where&#x27;</span>+@partition_key+</span><br><span class="line"><span class="string">&#x27; =&#x27;</span>+<span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">6</span>),@<span class="keyword">range</span>)</span><br><span class="line">exec sp_executeSQL @sSQL,@sParam,@month_keyOUt=@month_key <span class="keyword">output</span></span><br><span class="line"><span class="keyword">if</span>(@month_key!=@<span class="keyword">range</span> <span class="keyword">or</span> @month_key <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sp_msg=<span class="string">&#x27;data for &#x27;</span>+<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">6</span>),@<span class="keyword">range</span>)+<span class="string">&#x27; not ready for loading&#x27;</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">right</span>(<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">6</span>),@<span class="keyword">range</span>),<span class="number">2</span>)=<span class="string">&#x27;12&#x27;</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">range</span>=<span class="keyword">convert</span>(<span class="built_in">int</span>,(<span class="keyword">left</span>(<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">6</span>),@<span class="keyword">range</span>),<span class="number">4</span>)+<span class="number">1</span>))*<span class="number">100</span>+<span class="number">1</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">range</span>+=<span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--add try catch block statment</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--error handling statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Check-up-target-table-partition"><a href="#Check-up-target-table-partition" class="headerlink" title="Check up target table partition"></a>Check up target table partition</h3><p>From previous post about table partitioning basics, the last requirement for partition switching is partition in target table must be empty, so it’s necessary to check whether target table partition has data in it, if it’s empty, that is good and we are ready to do the partition switching, but in production environment, we usually need to handle more complicated situations like rerun after job failed so definitely have to take it into account when target partition has data and deal with it. Firstly, let’s check target partition:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> IsPartitionLoaded @table_name</span><br><span class="line">,@partition_col <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;month_key&#x27;</span></span><br><span class="line">,@<span class="keyword">range</span> <span class="built_in">int</span></span><br><span class="line">,@ret <span class="built_in">int</span>=<span class="number">0</span> <span class="keyword">output</span></span><br><span class="line">,@dbname <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> @sSQL <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">,@sParam <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@monthKey <span class="built_in">int</span></span><br><span class="line">,@sp_msg <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">set</span> @table_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@table_name))</span><br><span class="line"><span class="keyword">if</span>(@table_name=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @table_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end up with @table_name empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @partition_col=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@partition_col))</span><br><span class="line"><span class="keyword">if</span>(@partition_col=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @partition_col <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end up with @partition_col empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>(isnumeric(@<span class="keyword">range</span>)!=<span class="number">1</span> <span class="keyword">or</span> <span class="keyword">not</span>(<span class="keyword">len</span>(<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">8</span>),@<span class="keyword">range</span>))=<span class="number">6</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sp_msg=<span class="string">&#x27;end up with @range out of range, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @ret=<span class="number">1</span> <span class="comment">--target partition has data</span></span><br><span class="line"><span class="keyword">set</span> sParam=<span class="string">&#x27;@retOut int output&#x27;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;select top 1 @retOut=&#x27;</span>+@partition_col+<span class="string">&#x27; from &#x27;</span>+<span class="string">&#x27;.dbo.&#x27;</span>+@table_name+</span><br><span class="line"><span class="string">&#x27;where &#x27;</span>+@partition_col+<span class="string">&#x27; =&#x27;</span>+<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">6</span>),@<span class="keyword">range</span>)</span><br><span class="line">exec sp_executeSQL @sSQL, @sParam, @retOut=@monthKey <span class="keyword">output</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span> (@monthKey <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">or</span> @monthkey=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @ret=<span class="number">0</span> <span class="comment">--target partition is empty</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="keyword">set</span> @ret = <span class="number">-1</span></span><br><span class="line"><span class="comment">--add try catch block statment</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="keyword">set</span> @ret = <span class="number">-1</span></span><br><span class="line"><span class="comment">--error handling statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Get-proper-partition-numbers-for-source-switch-and-target-table"><a href="#Get-proper-partition-numbers-for-source-switch-and-target-table" class="headerlink" title="Get proper partition numbers for source (switch) and target table"></a>Get proper partition numbers for source (switch) and target table</h3><p>Let’s first handle ideal key which is empty in target partition, the last preparation we have to know is find out proper partition number on both source and target sides so that we are able to switch to right target partition.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> usp_getPatitionNum @pf_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@<span class="keyword">range</span> <span class="built_in">int</span></span><br><span class="line">,@pn <span class="built_in">int</span> <span class="keyword">output</span></span><br><span class="line">,@dbname <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> @sp_msg <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">set</span> @pf_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@pf_name))</span><br><span class="line"><span class="keyword">if</span>(@pf_name=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @pf_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end up with @pf_name is empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>((<span class="keyword">not</span> isnumeric(@<span class="keyword">range</span>)=<span class="number">1</span>)<span class="keyword">or</span> (@<span class="keyword">range</span>&lt;<span class="number">100000</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end up with @range is out of range, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">declare</span> @sParam <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@sSQL <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> @<span class="keyword">range</span>&lt;<span class="number">10000000</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; select @pnOut=$PARTITION.&#x27;</span>+@pf_name+<span class="string">&#x27;(&#x27;</span>+<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">6</span>),@<span class="keyword">range</span>)+<span class="string">&#x27;)&#x27;</span></span><br><span class="line"><span class="keyword">set</span> @sParam=<span class="string">&#x27;@pnOut int output&#x27;</span></span><br><span class="line">exec sp_executeSQL @sSQL, @sParam, @pnOut=@pn <span class="keyword">output</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--add try catch block statment</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--error handling statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Partition-switching"><a href="#Partition-switching" class="headerlink" title="Partition switching"></a>Partition switching</h3><p>Now, it’s time for us to switch partition to target table </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> usp_switchPartition @srctbl_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@destbl_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@src_pn <span class="built_in">int</span>=<span class="number">0</span></span><br><span class="line">,@des_pn <span class="built_in">int</span>=<span class="number">0</span></span><br><span class="line">,@dbname <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> @pn <span class="built_in">int</span></span><br><span class="line">,@sSQL <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">,@sParam <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@ncount <span class="built_in">int</span></span><br><span class="line">,@sp_msg <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">set</span> @srctbl_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@srctbl_name))</span><br><span class="line"><span class="keyword">if</span>(@srctbl_name=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @srctbl_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end up with @srctbl_name empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @destbl_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@destbl_name))</span><br><span class="line"><span class="keyword">if</span>(@destbl_name=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @srctbl_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end up with @destbl_name empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; alter table &#x27;</span>+@dbname+<span class="string">&#x27;.dbo.&#x27;</span>+<span class="keyword">quotename</span>(@srctbl_name)</span><br><span class="line"><span class="keyword">if</span>(@src_pn&gt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27; switch partition &#x27;</span>+<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">4</span>),@src_pn)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27; switch &#x27;</span></span><br><span class="line"><span class="keyword">if</span>(@des_pn &gt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27; to&#x27;</span>+@dbname+<span class="string">&#x27;.dbo.&#x27;</span></span><br><span class="line">+ <span class="keyword">quotename</span>(@destbl_name)+<span class="string">&#x27; partition &#x27;</span></span><br><span class="line">+ <span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">4</span>),@des_pn)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=@sSQL+<span class="string">&#x27; to &#x27;</span>+@dbname+<span class="string">&#x27;.dbo.&#x27;</span></span><br><span class="line">+ <span class="keyword">quotename</span>(<span class="comment">#destbl_name)</span></span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--add try catch block statment</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--error handling statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Clean-the-switch-table-after-partition-switching"><a href="#Clean-the-switch-table-after-partition-switching" class="headerlink" title="Clean the switch table after partition switching"></a>Clean the switch table after partition switching</h3><p>The switch table is going to be empty after partition switching so it’s useless now and can be drop from database as well as partition function and scheme</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> usp_cleanTable @table_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@partition_col <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;month_key&#x27;</span></span><br><span class="line">,@dbname <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">as</span> </span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> sp_msg <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">set</span> @table_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@table_name))</span><br><span class="line"><span class="keyword">if</span>(@table_name=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @table_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end up with @table_name empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">declare</span> @sSQL <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">,@constraint_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@return_result <span class="built_in">int</span></span><br><span class="line">,@pf_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@ps_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">@<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @pf_name=@dbname+<span class="string">&#x27;_PF_&#x27;</span>+@table_name</span><br><span class="line"><span class="keyword">set</span> @ps_name=@dbname+<span class="string">&#x27;_PS_&#x27;</span>+@table_name</span><br><span class="line"><span class="comment">--drop table</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">name</span>=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; select @name=name from sys.tables where name=&#x27;&#x27;&#x27;</span>+@table_name+<span class="string">&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">exec sp_executeSQL @sSQL, <span class="string">&#x27;@name varchar(100) output&#x27;</span>,@<span class="keyword">name</span>=@<span class="keyword">name</span> <span class="keyword">output</span></span><br><span class="line"><span class="keyword">if</span>(@<span class="keyword">name</span>!=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; drop table dbo.&#x27;</span>+@table_name</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="comment">--drop partition scheme</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">name</span>=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; select @name=name from sys.partition_schemes where name=&#x27;&#x27;&#x27;</span>+@ps_name+<span class="string">&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">exec sp_executeSQL @sSQL, <span class="string">&#x27;@name varchar(100) output&#x27;</span>, @<span class="keyword">name</span>=@<span class="keyword">name</span> <span class="keyword">output</span></span><br><span class="line"><span class="keyword">if</span>(@<span class="keyword">name</span>!=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; drop partition scheme&#x27;</span>+@ps_name</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--drop partition function</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">name</span>=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; select @name=name from sys.partition_functions where name=&#x27;&#x27;&#x27;</span>+@pf_name+<span class="string">&#x27;&#x27;&#x27;&#x27;</span></span><br><span class="line">exec sp_executeSQL @sSQL, <span class="string">&#x27;@name varchar(100) output&#x27;</span>, @<span class="keyword">name</span>=@<span class="keyword">name</span> <span class="keyword">output</span></span><br><span class="line"><span class="keyword">if</span>(@<span class="keyword">name</span>!=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=<span class="string">&#x27;use &#x27;</span>+@dbname+<span class="string">&#x27;; drop partition function&#x27;</span>+@ps_name</span><br><span class="line">exec sp_executeSQL @sSQL</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--add try catch block statment</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--error handling statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Swap-data-out-of-target-partition-to-temp-table"><a href="#Swap-data-out-of-target-partition-to-temp-table" class="headerlink" title="Swap data out of target partition to temp table"></a>Swap data out of target partition to temp table</h3><p>A special stored procedure is needed to switch data out of target partition if there would be data in there.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> dbo.unloadData @table_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@tempTbl <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@<span class="keyword">range</span> <span class="built_in">int</span>,</span><br><span class="line">,@partition_col <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;month_key&#x27;</span></span><br><span class="line">,@dbname <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> @pn <span class="built_in">int</span></span><br><span class="line">,@pnd <span class="built_in">int</span></span><br><span class="line">,@return_result <span class="built_in">int</span></span><br><span class="line">,@filegroup_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@pf_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@isRead <span class="built_in">int</span></span><br><span class="line">,@sp_msg <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@ps_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @table_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@table_name))</span><br><span class="line"><span class="keyword">if</span>(@table_name=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @table_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sp_msg=<span class="string">&#x27;end up with @table_name empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">not</span> isnumeric(@<span class="keyword">range</span>)=<span class="number">1</span> <span class="keyword">or</span> @<span class="keyword">range</span>&lt;<span class="number">100000</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sp_msg=<span class="string">&#x27;end up with @range out of range, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @pf_name=@dbname+<span class="string">&#x27;_PF_&#x27;</span>+@table_name</span><br><span class="line"><span class="comment">--get src table partition</span></span><br><span class="line">exec @return_result=business_db.dbo.usp_getPatitionNum @pf_name=@pf_name</span><br><span class="line">,@<span class="keyword">range</span>=@<span class="keyword">range</span></span><br><span class="line">,@pn=@pn <span class="keyword">output</span></span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>(@tempTbl=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">set</span> @tempTbl=<span class="string">&#x27;Temp_&#x27;</span>+@table_name</span><br><span class="line"><span class="comment">--get des table partition</span></span><br><span class="line"><span class="keyword">set</span> @pf_name=@dbname+<span class="string">&#x27;_PF_&#x27;</span>+@tempTbl</span><br><span class="line">exec @return_result=business_db.dbo.usp_getPatitionNum @pf_name=@pf_name</span><br><span class="line">,@<span class="keyword">range</span>=@<span class="keyword">range</span></span><br><span class="line">,@pn=@pnd <span class="keyword">output</span></span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--swap data out from target partition to temp table</span></span><br><span class="line">exec @return_result=business_db.dbo.usp_switchPartition @srctbl_name=@table_name</span><br><span class="line">,@destbl_name=@tempTbl</span><br><span class="line">,@src_pn=@pn</span><br><span class="line">,@des_pn=@pnd</span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--add try catch block statment</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--error handling statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Control-console-script-to-integrate-all-functions"><a href="#Control-console-script-to-integrate-all-functions" class="headerlink" title="Control console script to integrate all functions"></a>Control console script to integrate all functions</h3><p>We are now all set so it’s time to integrate all those stored procedure into one control console to implement the partition switching task.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> dbo.usp_switchData @scrtable_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@table_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@lrange <span class="built_in">int</span></span><br><span class="line">,@urange <span class="built_in">int</span></span><br><span class="line">,@partiton_col <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;month_key&#x27;</span></span><br><span class="line">,@dbname <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> @sp_msg <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="comment">--check input values</span></span><br><span class="line"><span class="keyword">set</span> @srctable_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@srctable_name))</span><br><span class="line"><span class="keyword">if</span>(@srctable_name=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @srctable_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sp_msg=<span class="string">&#x27;end up with @srctable_name empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">set</span> @table_name=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@table_name))</span><br><span class="line"><span class="keyword">if</span>(@table_name=<span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> @table_name <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sp_msg=<span class="string">&#x27;end up with @table_name empty, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>((<span class="keyword">not</span> isnumeric(@lrange)=<span class="number">1</span>) <span class="keyword">or</span> (@lrange &lt; <span class="number">100000</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sp_msg=<span class="string">&#x27;end up with @lrange out of range, check input value&#x27;</span></span><br><span class="line"><span class="keyword">goto</span> errorProc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>(@urange=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">set</span> @urange=@lrange</span><br><span class="line"><span class="keyword">set</span> @partition_col=<span class="keyword">ltrim</span>(<span class="keyword">rtrim</span>(@partition_col))</span><br><span class="line"><span class="comment">--declare local variables</span></span><br><span class="line"><span class="keyword">declare</span> @sSQ <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">,@check_constraint <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@pf_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@ps_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@staging_pf_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@staging_ps_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@filegroup_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@desfilegroup_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@range_count <span class="built_in">int</span></span><br><span class="line">,@<span class="keyword">range</span> <span class="built_in">int</span></span><br><span class="line">,@sParam <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@ret <span class="built_in">int</span></span><br><span class="line">,@pn <span class="built_in">int</span></span><br><span class="line">,@pn_staging <span class="built_in">int</span></span><br><span class="line">,@index_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">,@return_result <span class="built_in">int</span></span><br><span class="line">,@destbl_lrange <span class="built_in">int</span></span><br><span class="line"><span class="comment">--set values</span></span><br><span class="line"><span class="keyword">set</span> @pf_name=@dbname+<span class="string">&#x27;_PF_&#x27;</span>+@table_name</span><br><span class="line"><span class="keyword">set</span> @ps_name=@dbname+<span class="string">&#x27;_PS_&#x27;</span>+table_name</span><br><span class="line"><span class="keyword">set</span> @staging_pf_name=@dbname+<span class="string">&#x27;_PF_&#x27;</span>+srctable_name</span><br><span class="line"><span class="keyword">set</span> @staging_pf_name=@dbname+<span class="string">&#x27;_PS_&#x27;</span>+srctable_name</span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">range</span>=@lrange</span><br><span class="line"><span class="keyword">set</span> @range_count=<span class="number">0</span></span><br><span class="line"><span class="keyword">set</span> @pn_staging=<span class="number">0</span></span><br><span class="line"><span class="comment">--check if switch table data is ready for the range from @lrange to @urange</span></span><br><span class="line">exec @return_result=business_db.dbo.usp_IsStgDataReady @stgtbl_name=@srctable_name</span><br><span class="line">,@partition_col=@partiton_col</span><br><span class="line">,@lrange=@lrange</span><br><span class="line">,@urange=urange</span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--begin while loop transaction</span></span><br><span class="line"><span class="keyword">declare</span> @tempTbl <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">set</span> @temTbl=<span class="string">&#x27;Temp&#x27;</span>+@table_name</span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">range</span>=@lrange</span><br><span class="line"><span class="keyword">while</span> @<span class="keyword">range</span>&lt;=@urange</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @range_count+=<span class="number">1</span></span><br><span class="line"><span class="comment">--check if data is in target partition</span></span><br><span class="line"><span class="keyword">set</span> @ret=<span class="number">0</span></span><br><span class="line">exec return_result=business_db.dbo.IsPartitionLoaded @table_name=@table_name</span><br><span class="line">,@partition_col=@partition_col</span><br><span class="line">,@<span class="keyword">range</span>=@<span class="keyword">range</span></span><br><span class="line">,@ret=@ret <span class="keyword">output</span></span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@ret=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--create temp table to hold swapped data</span></span><br><span class="line">exec @return_result=busienss_db.dbo.usp_createPartitionTable @table_name=@table_name</span><br><span class="line">,@partition_col=@partition_col</span><br><span class="line">,@created_table=@tempTbl</span><br><span class="line">,@lrange=@lrange</span><br><span class="line">,@rrange=@urange</span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--create columnstore index for temTbl</span></span><br><span class="line">exec @return_result=business_db.dbo.usp_createColmart @table_name=temTbl</span><br><span class="line">,@scr_table=@table_name</span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--swap data to temp table</span></span><br><span class="line">exec @return_result=business_db.dbo.usp_unloadData @table_name=@table_name</span><br><span class="line">,@tempTbl=@tempTbl</span><br><span class="line">,@<span class="keyword">range</span>=@<span class="keyword">range</span></span><br><span class="line">,@partition_col=@partition_col</span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--get partition number from destination table</span></span><br><span class="line">exec @return_result=business_db.dbo.usp_getPatitionNum @pf_name=@pf_name</span><br><span class="line">,@<span class="keyword">range</span>=<span class="keyword">range</span></span><br><span class="line">,@pn=@pn <span class="keyword">output</span></span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--get partition number from switch table</span></span><br><span class="line">exec @return_result=business_db.dbo.usp_getPatitionNum @pf_name=@staging_pf_name</span><br><span class="line">,@<span class="keyword">range</span>=<span class="keyword">range</span></span><br><span class="line">,@pn=@pn_staging <span class="keyword">output</span></span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--partition switching from switch to target partition</span></span><br><span class="line">exec @return_result=business_db.dbo.usp_switchPartition @srctbl_name=@src_name</span><br><span class="line">,@destbl_name=@table_name</span><br><span class="line">,@src_pn=@pn_staging</span><br><span class="line">,@des_pn@pn</span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span>(@yearload_flag=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">right</span>(<span class="keyword">convert</span>(<span class="built_in">char</span>(<span class="number">6</span>),@<span class="keyword">range</span>),<span class="number">2</span>)=<span class="string">&#x27;12&#x27;</span>)</span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">range</span>=(<span class="keyword">convert</span>(<span class="built_in">int</span>,<span class="keyword">left</span>(<span class="keyword">convert</span>(<span class="number">6</span>),@<span class="keyword">range</span>)<span class="number">4</span>))+<span class="number">1</span>)*<span class="number">100</span>+<span class="number">1</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">range</span>+=<span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">range</span>+=<span class="number">100</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--drop temp table</span></span><br><span class="line">exec @return_result=business_db.dbo.usp_cleanTable @table_name=@tempTbl</span><br><span class="line">,@partition_col=@partition_col</span><br><span class="line">,@dbname=@dbname</span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--add try catch block statment</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--error handling statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Business-data-API-for-final-transaction-partition-switching"><a href="#Business-data-API-for-final-transaction-partition-switching" class="headerlink" title="Business data API for final transaction partition switching"></a>Business data API for final transaction partition switching</h3><p>All in all, we are going to integrate all encapsulated stored procedures into one data API to take input parameter value from outside then accomplish the task which is partition switch transaction data 100mm records in flash.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> business_db</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> transaction_partition_switch </span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> @month_key <span class="built_in">int</span></span><br><span class="line">,@return_result <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> top <span class="number">1</span> @month_key=month_key <span class="keyword">from</span> staging.dbo.transaction</span><br><span class="line">exec @return_result=business_db.dbo.usp_switchData @scrtable_name=<span class="string">&#x27;switch_transaction&#x27;</span></span><br><span class="line">,@table_name=<span class="string">&#x27;transaction&#x27;</span></span><br><span class="line">,@lrange=@month_key</span><br><span class="line">,@urange=<span class="number">0</span></span><br><span class="line">,@partition_col=<span class="string">&#x27;month_key&#x27;</span></span><br><span class="line">,@yearload_flag=<span class="number">0</span></span><br><span class="line">,@dbname=<span class="string">&#x27;business_db&#x27;</span></span><br><span class="line"><span class="keyword">if</span>(@return_result&lt;<span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--add some log statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="comment">--add try catch block statment</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line">errorProc:</span><br><span class="line"><span class="comment">--error handling statement</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="A-sub-process-of-partition-switching-for-error-handling-and-restatement-in-production"><a href="#A-sub-process-of-partition-switching-for-error-handling-and-restatement-in-production" class="headerlink" title="A sub-process of partition switching for error handling and restatement in production"></a>A sub-process of partition switching for error handling and restatement in production</h2><p>[In previous chapter](Get proper partition numbers for source (switch) and target table), we talk about the ideal case which is there is no data or empty in target partition, but in real production environment, situation is more complicated, some unpredicted event might cause data process failed or business redefined some data elements so that reprocess and restatement is necessary, in those cases, the target partition usually has data in it, that is the thing we have to deal with.</p>
<p>The approach is the same, partition switching will help us out. The main idea is to create another partition temp table with the same table structure, partition column and index setting as target table in the same file group then swap data out of target partition to temp table counterpart partition, finally drop the temp table and it’s partition function and scheme.</p>
<p><img src="/img/screenshots/partitionSwitchRestatement.png" alt="partitionSwitchRestatement.png"></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Above, we go through the whole solution on how to apply SQL table partitioning technic to implement partition switching in real ETL process so that we can easily to schedule it run on regular basis, I believe process automation is a valuable AI technic for business operation, because the best use-case for AI projects will reduce costs, reduce risk and improve profits. more often than not, the best results are seen from implementing AI to handle the small, repetitive tasks that businesses do on a daily basis.</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/SQL-Server-partitioning/">SQL Server, partitioning</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/01/01/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-3/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">SQL Server Table Partitioning in Large Scale Data Warehouse 3</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/12/25/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-1/"><span class="level-item">SQL Server Table Partitioning in Large Scale Data Warehouse 1</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://blog.hermanteng.net/2020/12/26/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-2/';
            this.page.identifier = '2020/12/26/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-2/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'herman-hexo-blog' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar1.png" alt="Herman"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Herman</p><p class="is-size-6 is-block">Data Analyst&amp;Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Toronto, Canada</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">23</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">20</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/HermanTeng19" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/HermanTeng19"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#What-is-the-main-idea-for-production-operation"><span class="level-left"><span class="level-item">1</span><span class="level-item">What is the main idea for production operation?</span></span></a></li><li><a class="level is-mobile" href="#Create-switch-table-task"><span class="level-left"><span class="level-item">2</span><span class="level-item">Create switch table task</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Create-partition-function-and-scheme-for-switch-table"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">Create partition function and scheme for switch table</span></span></a></li><li><a class="level is-mobile" href="#Replicate-target-table-structure-column-and-data-type-for-switch-table"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">Replicate target table structure (column and data type) for switch table</span></span></a></li><li><a class="level is-mobile" href="#Replicate-target-table-cluster-index-for-switch-table"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">Replicate target table cluster index for switch table</span></span></a></li><li><a class="level is-mobile" href="#Create-partitioned-switch-table"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">Create partitioned switch table</span></span></a></li><li><a class="level is-mobile" href="#Business-data-API"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">Business data API</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Load-staging-transaction-data-into-switch-table"><span class="level-left"><span class="level-item">3</span><span class="level-item">Load staging transaction data into switch table</span></span></a></li><li><a class="level is-mobile" href="#Create-columnstore-index-for-switch-table"><span class="level-left"><span class="level-item">4</span><span class="level-item">Create columnstore index for switch table</span></span></a></li><li><a class="level is-mobile" href="#Partition-switching-to-load-data-to-target-table"><span class="level-left"><span class="level-item">5</span><span class="level-item">Partition switching to load data to target table</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Check-data-in-switch-staging-table-is-in-the-right-range-and-ready-to-be-proceeded"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">Check data in switch (staging) table is in the right range and ready to be proceeded</span></span></a></li><li><a class="level is-mobile" href="#Check-up-target-table-partition"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">Check up target table partition</span></span></a></li><li><a class="level is-mobile" href="#Get-proper-partition-numbers-for-source-switch-and-target-table"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">Get proper partition numbers for source (switch) and target table</span></span></a></li><li><a class="level is-mobile" href="#Partition-switching"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">Partition switching</span></span></a></li><li><a class="level is-mobile" href="#Clean-the-switch-table-after-partition-switching"><span class="level-left"><span class="level-item">5.5</span><span class="level-item">Clean the switch table after partition switching</span></span></a></li><li><a class="level is-mobile" href="#Swap-data-out-of-target-partition-to-temp-table"><span class="level-left"><span class="level-item">5.6</span><span class="level-item">Swap data out of target partition to temp table</span></span></a></li><li><a class="level is-mobile" href="#Control-console-script-to-integrate-all-functions"><span class="level-left"><span class="level-item">5.7</span><span class="level-item">Control console script to integrate all functions</span></span></a></li><li><a class="level is-mobile" href="#Business-data-API-for-final-transaction-partition-switching"><span class="level-left"><span class="level-item">5.8</span><span class="level-item">Business data API for final transaction partition switching</span></span></a></li></ul></li><li><a class="level is-mobile" href="#A-sub-process-of-partition-switching-for-error-handling-and-restatement-in-production"><span class="level-left"><span class="level-item">6</span><span class="level-item">A sub-process of partition switching for error handling and restatement in production</span></span></a></li><li><a class="level is-mobile" href="#Conclusion"><span class="level-left"><span class="level-item">7</span><span class="level-item">Conclusion</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatar1.png" alt="Herman-blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 Herman Teng</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>