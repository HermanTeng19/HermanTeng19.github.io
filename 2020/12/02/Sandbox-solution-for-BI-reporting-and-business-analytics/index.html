<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>Sandbox solution for BI reporting and business analytics | Herman-blog</title>
    <meta name="author" content="Herman Teng" />
    <meta name="keywords" content="Data, Analysis, JavaScript, Python, SQL, NoSQL, Web, Finance, Banking" />
    <meta name="description" content="At beginning, I’d like to share a story from my client and business partner. One day, my team worked on a big marketing project, data from all kinds of source like spreadsheet, csv, mainframe and SQL Server, we had to do cross reference all those dat" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    
    <link rel="icon" href="/images/favicon1.ico">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
<meta name="generator" content="Hexo 5.2.0"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">Herman-blog</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">Home</span>
            </a>
        
            <a class="nav-item" href="/categories/data">
                <span class="nav-text">Data</span>
            </a>
        
            <a class="nav-item" href="/categories/it">
                <span class="nav-text">IT</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">Tags</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">Archives</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">About</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="https://hermanteng19.github.io"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Sandbox-database-brief-introduction"><span class="toc-number">1.</span> <span class="toc-text">Sandbox database brief introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-things-should-be-considered-before"><span class="toc-number">2.</span> <span class="toc-text">What things should be considered before</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-sandbox-database-walk-through"><span class="toc-number">3.</span> <span class="toc-text">Creating sandbox database walk through</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Define-and-create-a-new-database"><span class="toc-number">3.1.</span> <span class="toc-text">Define and create a new database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Grant-user-permissions"><span class="toc-number">3.2.</span> <span class="toc-text">Grant user permissions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Create-database-level-trigger-on-DDL-query-control-for-rules-and-restrictions"><span class="toc-number">3.3.</span> <span class="toc-text">Create database level trigger on DDL query control for rules and restrictions</span></a></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 1200px">
                <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            Sandbox solution for BI reporting and business analytics
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="https://hermanteng19.github.io/2020/12/02/Sandbox-solution-for-BI-reporting-and-business-analytics/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2020-12-02T15:41:48.000Z" itemprop="datePublished">2020-12-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/sandbox-SQL-SQL-Server-database/" rel="tag">sandbox, SQL, SQL Server, database</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>At beginning, I’d like to share a story from my client and business partner. One day, my team worked on a big marketing project, data from all kinds of source like spreadsheet, csv, mainframe and SQL Server, we had to do cross reference all those data to generate analysis reports but the headache thing was they were isolated and no way to put them into a single unique environment to run one time query then return the results so we could only open multiple windows to compare them by eyeballs. </p>
<p>During the project, we often composed some complex queries then ran for a long time to return the result dataset, those datasets were quite important for future further analysis and share with the whole team, but the another panic thing was we could not save those dataset into database due to insufficient access so what we did was copy and paste everything in excel spreadsheet, after for a while, we found number of excel file explode and hard to find the report among those huge files, we feed up with the tedious work and decided created a bunch of views in database but that was also not controlled by us but infrastructure team, all we could do was submit the request then followed infrastructure team’s schedule and waited for month end deployment, no matter how urgent those reports would be.</p>
<p>That is the story, I think if you had ever experienced that, that solution might be right for you. </p>
<a id="more"></a>

<p>You might get the common points from above story, it’s inefficient and even painful if you can only leverage data from data warehouse tables, that is reason why the sandbox database comes up which is a brand new data play zone on production with ability of pipeline to bring multiple sources of data based on major data warehouse you are using. In a brief mark, sandbox is aiming to build a <strong><em>homogeneous solution</em></strong> for <strong><em>heterogenous environment</em></strong>.</p>
<p>How to build up and what is the foundation of sandbox database, now let’s take a look into it.</p>
<p><img src="https://p.130014.xyz/2020/12/03/sandbox_structure.png" alt="sandbox_structure.png"></p>
<p>The Major data source is so called <code>big db</code>, but it’s data warehouse so that user was only assigned read access which means you can do nothing but only select and query data. Now we carved out two new databases - <code>sandbox</code> and <code>control db</code>.</p>
<h2 id="Sandbox-database-brief-introduction"><a href="#Sandbox-database-brief-introduction" class="headerlink" title="Sandbox database brief introduction"></a>Sandbox database brief introduction</h2><p>sandbox is the new data loading zone for slicing and dicing data in production, like you own backyard playground, you can do almost anything you want to do with it, so user will be granted both read and write permission. control_db that is control console station to provide access gateway for sandbox and also monitor and logging the users’ behaviors, just like a guardian to promise the safety and healthy for sandbox.</p>
<p>Let’s take a closer look at these two databases. Sandbox, in general, user can perform 3 kinds of actions, DDL, DML as well as batch job execution based on stored procedure. With DDL command which is database define language, user can create table/view/stored procedure, alter them, even drop them. With DML command which is database manipulate language, user can insert/update/delete data from existing table and also import data from other source. The batch operation is fit for user with programming background and write multiple queries with logical sequence into it like conditional and looping function by using T-SQL scripting language in terms of stored procedure.</p>
<h2 id="What-things-should-be-considered-before"><a href="#What-things-should-be-considered-before" class="headerlink" title="What things should be considered before"></a>What things should be considered before</h2><p>A very critical point for sandbox database is <strong>object ownership</strong>, which means you can <em>only create and deal with your own database objects plus read others’ object</em>. Image you data or analytical work were deleted by other accidently, how would you feel at the moment, so the restriction must be setup along with the sandbox database creation to promise the user data safety.</p>
<p><img src="https://p.130014.xyz/2020/12/03/noDMLTable.png" alt="noDMLTable.png"></p>
<p><img src="https://p.130014.xyz/2020/12/03/noDropTable.png" alt="noDropTable.png"></p>
<p>Another important thing need to be considered before is user data volume control. Unlike data warehouse, data volume increasing is followed trend and stable for each year, but sandbox database size is unpredictable and totally depends on user personal behavior, in order to prevent non-critical user data dominants your server hard disk, it’s very necessary to set quota for each users. When reach to the limit then</p>
<ul>
<li>User won’t be allowed to create table</li>
<li>User also won’t be allowed insert new data into existing table</li>
</ul>
<p>until manually clean data and release space.</p>
<p><img src="https://p.130014.xyz/2020/12/03/quotaLimit.png" alt="quotaLimit.png"></p>
<h2 id="Creating-sandbox-database-walk-through"><a href="#Creating-sandbox-database-walk-through" class="headerlink" title="Creating sandbox database walk through"></a>Creating sandbox database walk through</h2><h3 id="Define-and-create-a-new-database"><a href="#Define-and-create-a-new-database" class="headerlink" title="Define and create a new database"></a>Define and create a new database</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="keyword">master</span>;</span><br><span class="line">go</span><br><span class="line">if DB_ID(&#x27;sandbox&#x27;) is not null</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">database</span> sandbox</span><br><span class="line"><span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<p>in real production, you might need to create a new file group and bunch of file under it for better management.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> sandbox</span><br><span class="line"><span class="keyword">on</span> primary</span><br><span class="line">(<span class="keyword">name</span>=N<span class="string">&#x27;sandbox&#x27;</span>, filename=N<span class="string">&#x27;G:\sqldata\sandbox.mdf&#x27;</span>, <span class="keyword">size</span>=<span class="number">1048</span>kB, <span class="keyword">maxsize</span>=<span class="number">5124</span>KB, filegrowth=<span class="number">512</span>KB),</span><br><span class="line">filegroup [yourTeam_sandbox]</span><br><span class="line">(<span class="keyword">name</span>=N<span class="string">&#x27;yourTeam_sandbox_FG1&#x27;</span>,filename=N<span class="string">&#x27;G:\sqldata\yourTeam_sandbox1.ndf&#x27;</span>,<span class="keyword">size</span>=<span class="number">1048</span>KB, <span class="keyword">maxsize</span>=<span class="number">5124</span>KB, filegrowth=<span class="number">512</span>KB),</span><br><span class="line">(<span class="keyword">name</span>=N<span class="string">&#x27;yourTeam_sandbox_FG2&#x27;</span>,filename=N<span class="string">&#x27;G:\sqldata\yourTeam_sandbox2.ndf&#x27;</span>,<span class="keyword">size</span>=<span class="number">1048</span>KB, <span class="keyword">maxsize</span>=<span class="number">5124</span>KB, filegrowth=<span class="number">512</span>KB),</span><br><span class="line">(<span class="keyword">name</span>=N<span class="string">&#x27;yourTeam_sandbox_FG3&#x27;</span>,filename=N<span class="string">&#x27;G:\sqldata\yourTeam_sandbox3.ndf&#x27;</span>,<span class="keyword">size</span>=<span class="number">1048</span>KB, <span class="keyword">maxsize</span>=<span class="number">5124</span>KB, filegrowth=<span class="number">512</span>KB)</span><br><span class="line"><span class="keyword">log</span> <span class="keyword">on</span></span><br><span class="line">(<span class="keyword">name</span>=N<span class="string">&#x27;yourTeam_sandbox_log&#x27;</span>,filename=N<span class="string">&#x27;H:\sqllog\yourTeam_sandbox_log.ldf&#x27;</span>,<span class="keyword">size</span>=<span class="number">1048</span>KB, <span class="keyword">maxsize</span>=<span class="number">5124</span>KB, filegrowth=<span class="number">512</span>KB)</span><br><span class="line"><span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<p>make sure your sandbox and control console database have the same database ownership user</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="keyword">master</span>;</span><br><span class="line">go</span><br><span class="line"><span class="keyword">alter</span> authorization <span class="keyword">on</span> <span class="keyword">database</span>::sandbox</span><br><span class="line"><span class="keyword">to</span> sa</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"><span class="keyword">alter</span> authorization <span class="keyword">on</span> <span class="keyword">database</span>::control_db</span><br><span class="line"><span class="keyword">to</span> sa</span><br><span class="line"><span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<p>make sure your new created file group to be the default file group so that coming data is going to be allocated there</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> sandbox;</span><br><span class="line">go</span><br><span class="line">if not exists (<span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> sys.filegroups <span class="keyword">where</span> is_default=<span class="number">1</span> <span class="keyword">and</span> <span class="keyword">name</span>=N<span class="string">&#x27;sandbox&#x27;</span>)</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> sandbox <span class="keyword">modify</span> filegroup [yourTeam_sandbox] <span class="keyword">default</span></span><br><span class="line"><span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<h3 id="Grant-user-permissions"><a href="#Grant-user-permissions" class="headerlink" title="Grant user permissions"></a>Grant user permissions</h3><p>First, you need to provide the basic read access to your business user</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> sandbox;</span><br><span class="line">go</span><br><span class="line">if exists (<span class="keyword">select</span> * <span class="keyword">from</span> sys.database_principals <span class="keyword">where</span> <span class="keyword">name</span>=N<span class="string">&#x27;yourDomain\yourUserGroup&#x27;</span>)</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> [yourDomain\yourUserGroup]</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> [yourDomain\yourUserGroup] <span class="keyword">for</span> login [yourDomain\yourUserGroup] <span class="keyword">with</span> default_schema=dbo</span><br><span class="line">exec sp_addrolemember <span class="string">&#x27;db_datareader&#x27;</span>,<span class="string">&#x27;yourDomain\yourUserGroup&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>then assign to them DDL and DML permissions</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> sandbox;</span><br><span class="line">go</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">alter</span> <span class="keyword">any</span> <span class="keyword">schema</span> <span class="keyword">to</span> [yourDomain\yourUserGroup];</span><br><span class="line">go</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">create</span> <span class="keyword">procedure</span> <span class="keyword">to</span> [yourDomain\yourUserGroup];</span><br><span class="line">go</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">to</span> [yourDomain\yourUserGroup];</span><br><span class="line">go</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">create</span> <span class="keyword">view</span> <span class="keyword">to</span> [yourDomain\yourUserGroup];</span><br><span class="line">go</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">delete</span> <span class="keyword">to</span> [yourDomain\yourUserGroup];</span><br><span class="line">go</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">insert</span> <span class="keyword">to</span> [yourDomain\yourUserGroup];</span><br><span class="line">go</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">to</span> [yourDomain\yourUserGroup];</span><br><span class="line">go</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">update</span> <span class="keyword">to</span> [yourDomain\yourUserGroup];</span><br><span class="line">go</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">execute</span> <span class="keyword">to</span> [yourDomain\yourUserGroup];</span><br><span class="line">go</span><br></pre></td></tr></table></figure>

<h3 id="Create-database-level-trigger-on-DDL-query-control-for-rules-and-restrictions"><a href="#Create-database-level-trigger-on-DDL-query-control-for-rules-and-restrictions" class="headerlink" title="Create database level trigger on DDL query control for rules and restrictions"></a>Create database level trigger on DDL query control for rules and restrictions</h3><ol>
<li>encourage give table name starting with id number which is unique identifier for employee in your company like nameInitial2_tableName</li>
<li>must be eligible user, identity check by control database</li>
<li>no special characters are allowed in table name like !@#$%^&amp;-</li>
<li>no over quota allowed</li>
<li>not allowed user drop or delete others’ object and data</li>
</ol>
<p>let’s connect above constraints with workflow chart to be able to see the big picture</p>
<p><img src="https://p.130014.xyz/2020/12/05/sandbox_trigger_workflow.png" alt="sandbox_trigger_workflow.png"></p>
<p>First of all, we create the database trigger for enforcing object creation rules</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> ddltrg_create_table</span><br><span class="line"><span class="keyword">on</span> <span class="keyword">database</span></span><br><span class="line"><span class="keyword">with</span> <span class="keyword">execute</span> <span class="keyword">as</span> <span class="string">&#x27;dbo&#x27;</span></span><br><span class="line"><span class="keyword">for</span> create_table</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line">	<span class="keyword">set</span> noncount <span class="keyword">on</span>;</span><br><span class="line">	<span class="keyword">declare</span> @<span class="keyword">eventdata</span> <span class="keyword">xml</span></span><br><span class="line">	<span class="keyword">declare</span> @orig_object_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">	<span class="keyword">declare</span> @orig_user_name <span class="built_in">varchar</span>(<span class="number">25</span>)</span><br><span class="line">	<span class="keyword">declare</span> @alt_object_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">	<span class="keyword">declare</span> @alt_user_name <span class="built_in">varchar</span>(<span class="number">25</span>)</span><br><span class="line">	<span class="keyword">declare</span> @valid_chars <span class="built_in">varchar</span>(<span class="number">50</span>)</span><br><span class="line">	<span class="keyword">declare</span> @create_status <span class="built_in">char</span>(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">declare</span> @create_err_msg <span class="built_in">varchar</span>(<span class="number">250</span>)</span><br><span class="line">	<span class="keyword">declare</span> @rename_required <span class="built_in">char</span>(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">declare</span> @trigger_sql <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">	<span class="keyword">declare</span> @schema_name <span class="built_in">varchar</span>(<span class="number">25</span>)</span><br><span class="line">	<span class="keyword">declare</span> @trigger_insert <span class="built_in">varchar</span>(<span class="keyword">max</span>)</span><br><span class="line">	<span class="keyword">declare</span> @guid <span class="built_in">varchar</span>(<span class="number">32</span>)</span><br><span class="line">	<span class="keyword">declare</span> @overQuota_user <span class="keyword">table</span> (userId <span class="built_in">varchar</span>(<span class="number">25</span>) <span class="literal">null</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">set</span> @guid=<span class="string">&#x27;250&#x27;</span></span><br><span class="line">	<span class="keyword">set</span> @valid_chars = <span class="string">&#x27;%[^a-zA-Z0-9_]%&#x27;</span></span><br><span class="line">	<span class="keyword">set</span> @<span class="keyword">eventdata</span> = <span class="keyword">EVENTDATA</span>()</span><br><span class="line">	<span class="keyword">set</span> @orig_object_namne = @eventdata.value(<span class="string">&#x27;(/EVENT_INSTANCE/objectName)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(100)&#x27;</span>)</span><br><span class="line">	<span class="keyword">set</span> @orig_user_name = <span class="keyword">upper</span>(@eventdata.value(<span class="string">&#x27;(/EVENT/INSTANCE/LoginName)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(25)&#x27;</span>))</span><br><span class="line">	<span class="keyword">set</span> @create_status=<span class="string">&#x27;Y&#x27;</span></span><br><span class="line">	<span class="keyword">set</span> @create_err_msg=<span class="string">&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">set</span> @alt_user_name = <span class="keyword">right</span>(@orig_user_name,<span class="keyword">len</span>(@orig_user_name)-<span class="keyword">charindex</span>(<span class="string">&#x27;\\&#x27;</span>,@orig_user_name))</span><br><span class="line">	<span class="keyword">select</span> @schema_name = SCHEMA_NAME(SCHEMA_ID) <span class="keyword">from</span> sys.tables <span class="keyword">where</span> <span class="keyword">name</span> = @orig_object_name</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (@alt_user_name = <span class="string">&#x27;yourServiceAccout&#x27;</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">substring</span>(@orig_object_name,<span class="number">1</span>,<span class="keyword">len</span>(@alt_user_name)) = @orig_object_name</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">set</span> @alt_object_name = @orig_object_name</span><br><span class="line">		<span class="keyword">set</span> @rename_required = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">set</span> @alt_object_name = @orig_object_name</span><br><span class="line">		<span class="keyword">set</span> @rename_required = <span class="string">&#x27;Y&#x27;</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="comment">/*check the user eligibility*/</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> (<span class="keyword">select</span> * <span class="keyword">from</span> control_db.dbo.Audit_Sandbox_User <span class="keyword">where</span> User_ID = @alt_user_name)</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">set</span> @create_status = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">		<span class="keyword">set</span> @create_err_msg = <span class="string">&#x27;User: &#x27;</span> + @alt_user_name + <span class="string">&#x27; does not have privilege to use the sandbox database&#x27;</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">insert</span> <span class="keyword">into</span> @overQuota_user</span><br><span class="line">	<span class="keyword">select</span> user_id <span class="keyword">from</span> control_db.dbo.Audit_Sandbox_User <span class="keyword">where</span> sandbox_limit - current_usage &lt; <span class="number">0</span></span><br><span class="line">	<span class="comment">/*user control for over limit quota*/</span></span><br><span class="line">	<span class="keyword">if</span> @alt_user_name <span class="keyword">in</span> (<span class="keyword">select</span> userId <span class="keyword">from</span> @overQuota_user)</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">set</span> @create_status = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">		<span class="keyword">set</span> @create_err_msg = <span class="string">&#x27;User: &#x27;</span> + @alt_user_name + <span class="string">&#x27; exceeded designed space quota, &#x27;</span> + @alt_user_name + <span class="string">&#x27; is not able to  &#x27;</span> +</span><br><span class="line">		<span class="string">&#x27;create new table. Please delete data not needed to free up space so usage is less than quota 1024MB and rerun query again&#x27;</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="comment">/*check object name eligibility*/</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">patindex</span>(@valid_chars,@orig_object_name) &gt; <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">set</span> @create_status = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">		<span class="keyword">set</span> @create_err_msg = <span class="string">&#x27;Invalid characters in table name&#x27;</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="comment">/*check object existency*/</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">exists</span>(<span class="keyword">select</span> * <span class="keyword">from</span> sys.objects <span class="keyword">where</span> object_id=OBJECT_ID(@alt_object_name) <span class="keyword">and</span> <span class="keyword">type</span> <span class="keyword">in</span> (N<span class="string">&#x27;U&#x27;</span>))</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">if</span> @rename_required = <span class="string">&#x27;Y&#x27;</span></span><br><span class="line">		<span class="keyword">begin</span></span><br><span class="line">			<span class="keyword">set</span> @create_status = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">			<span class="keyword">set</span> @create_err_msg = <span class="string">&#x27;Table: &#x27;</span> + @alt_object_name + <span class="string">&#x27; already exists&#x27;</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="comment">/*check schema name eligibility*/</span></span><br><span class="line">	<span class="keyword">if</span> @schema_name &lt;&gt; <span class="string">&#x27;dbo&#x27;</span></span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">set</span> @create_status = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">		<span class="keyword">set</span> @create_err_msg = <span class="string">&#x27;Table: &#x27;</span> + @orig_object_name + <span class="string">&#x27; not created. Schema is not specified: dbo.&lt;table name&gt;!&#x27;</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">if</span> (@create_status = <span class="string">&#x27;N&#x27;</span>)</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">rollback</span></span><br><span class="line">		print @create_err_msg</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="comment">/*log sandbox event into tracking table in control_db*/</span></span><br><span class="line">	<span class="keyword">insert</span> control_db.dbo.Audit_Sandbox_Event_Tracking (Event_Type, Event_Time, Event_User, Event_Database, Event_Object_Name</span><br><span class="line">                                                       ,Event_Object_Type, Event_SQK, Audit_Created_Status, Audit_Error_Message)</span><br><span class="line">    	<span class="keyword">value</span> (@eventdata.value(<span class="string">&#x27;(/EVENT_INSTANCE/EventType)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(50)&#x27;</span>),</span><br><span class="line">               @eventdata.value(<span class="string">&#x27;(/EVENT_INSTANCE/PostTime)[1]&#x27;</span>,<span class="string">&#x27;datetime&#x27;</span>),</span><br><span class="line">               @Orig_user_name,</span><br><span class="line">               @eventdata.value(<span class="string">&#x27;(EVENT_INSTANCE/DatabaseName)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(25)&#x27;</span>),</span><br><span class="line">               @orig_object_name,</span><br><span class="line">               @eventdata.value(<span class="string">&#x27;(/EVENT_INSTANCE/ObjectType)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(25)&#x27;</span>),</span><br><span class="line">               @eventdata.value(<span class="string">&#x27;(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(max)&#x27;</span>),</span><br><span class="line">               <span class="keyword">case</span> <span class="keyword">when</span> @create_status = <span class="string">&#x27;Y&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;success&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;failed&#x27;</span> <span class="keyword">end</span>,</span><br><span class="line">               @create_err_msg</span><br><span class="line">              )                                                   </span><br><span class="line">     <span class="keyword">if</span> (@create_status = <span class="string">&#x27;N&#x27;</span>) </span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line">     <span class="comment">/*rename object to add user id prefix*/</span></span><br><span class="line">     <span class="keyword">begin</span></span><br><span class="line">     	exec sp_rename @orig_object_name, @alt_object_name</span><br><span class="line">     	print <span class="string">&#x27;Table name is renamed with prefix of your user id&#x27;</span></span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">     <span class="comment">/*creaet DML trigger on table level*/</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = <span class="string">&#x27;create trigger DML trig_&#x27;</span>+@alt_object_name+ <span class="string">&#x27;ON &#x27;</span> + @alt_object_name + <span class="string">&#x27;&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;for delete, update, insert&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;as&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;begin &#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	set nocount on;&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	declare @user varchar(25)&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	select @user = right(SUSER_NAME(),LEN(SUSER_NAME()) - CHARINDEX(&#x27;&#x27;\\&#x27;&#x27;,SUSER_NAME()))&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	IF @user &lt;&gt; &#x27;&#x27;&#x27;</span>+@alt_user_name+<span class="string">&#x27;&#x27;&#x27; &#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	begin&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;		rollback&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;		print &#x27;&#x27;User: &#x27;&#x27;+@user+&#x27;&#x27; does not have the privilege to perform a DML operation on table&#x27;</span> +@alt_object_name + <span class="string">&#x27;&#x27;&#x27; &#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	end&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27; end&#x27;</span></span><br><span class="line">     exec (@trigger_sql)</span><br><span class="line">     ;</span><br><span class="line">     <span class="comment">/*create over quota DML trigger on table level*/</span></span><br><span class="line">     <span class="keyword">create</span> <span class="keyword">table</span> <span class="comment">#overQuota (userId varchar(25) Null)</span></span><br><span class="line">     ;</span><br><span class="line"> 	<span class="keyword">set</span> @trigger_sql = <span class="string">&#x27;create trigger DML trig_&#x27;</span>+@alt_object_name+ <span class="string">&#x27;_insert ON &#x27;</span> + @alt_object_name + <span class="string">&#x27;&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;after insert&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;as&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;begin &#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	set nocount on;&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	declare @user varchar(25)&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	select @user = right(SUSER_NAME(),LEN(SUSER_NAME()) - CHARINDEX(&#x27;&#x27;\\&#x27;&#x27;,SUSER_NAME()))&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	insert into #overQuota&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	select user_id from control_db.dbo.Audit_Sandbox_User where sandbox_limit-current_usage&lt;0;&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	IF @user in (select userId from #overQuota)&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	begin&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;		rollback&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;		print &#x27;&#x27;User: &#x27;&#x27;+@user+&#x27;&#x27; is over quota on usage so it can not perform a INSERT operation on table&#x27;</span> +@alt_object_name + <span class="string">&#x27;, please delete data that is not needed to free up space then rerun the query&#x27;&#x27; &#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27;	end&#x27;</span></span><br><span class="line">     <span class="keyword">set</span> @trigger_sql = @trigger_sql + <span class="string">&#x27; end&#x27;</span></span><br><span class="line">     exec (@trigger_sql)</span><br><span class="line">     ;</span><br><span class="line">     <span class="keyword">drop</span> <span class="keyword">table</span> <span class="comment">#overQuota</span></span><br><span class="line">     ;</span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line">	<span class="keyword">declare</span> @err_msg <span class="built_in">varchar</span>(<span class="number">900</span>),</span><br><span class="line">		   @err_num <span class="built_in">int</span>,</span><br><span class="line">		   @err_line <span class="built_in">int</span>,</span><br><span class="line">		   @syserr <span class="built_in">varchar</span>(<span class="number">900</span>)</span><br><span class="line">     <span class="keyword">select</span> @err_msg = ERROR_MESSAGE(), @err_num = ERROR_NUMBER(), @err_line = ERROR_LINE()</span><br><span class="line">     <span class="keyword">set</span> @syserr = <span class="string">&#x27;Ended in DDLTRIG_CREATE_TABLE with errors: Line= &#x27;</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">10</span>), @err_line) + <span class="string">&#x27;, Error Num = &#x27;</span> + <span class="keyword">convert</span>(<span class="built_in">varchar</span>(<span class="number">10</span>), @err_num) + <span class="string">&#x27;, Error Msg= &#x27;</span> + @err_msg</span><br><span class="line">     <span class="comment">/*save to log file or control_db table*/</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line"><span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enable</span> <span class="keyword">trigger</span> [ddltrg_create_table] <span class="keyword">on</span> <span class="keyword">database</span></span><br><span class="line"><span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<p>One more run need to be applied is prevent user drop object which is not belong to that user.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> ddltrig_drop_table</span><br><span class="line"><span class="keyword">on</span> <span class="keyword">database</span></span><br><span class="line"><span class="keyword">with</span> <span class="keyword">execute</span> <span class="keyword">as</span> <span class="string">&#x27;dbo&#x27;</span></span><br><span class="line">	<span class="keyword">for</span> drop_table</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line">	<span class="keyword">set</span> nocount <span class="keyword">on</span>;</span><br><span class="line">	<span class="keyword">declare</span> @<span class="keyword">eventdata</span> <span class="keyword">xml</span></span><br><span class="line">	<span class="keyword">declare</span> @orig_object_name <span class="built_in">varchar</span>(<span class="number">100</span>)</span><br><span class="line">	<span class="keyword">declare</span> @orig_user_name <span class="built_in">varchar</span>(<span class="number">25</span>)</span><br><span class="line">	<span class="keyword">declare</span> @alt_user_name <span class="built_in">varchar</span>(<span class="number">25</span>)</span><br><span class="line">	<span class="keyword">declare</span> @create_status <span class="built_in">char</span>(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">declare</span> @create_err_msg <span class="built_in">varchar</span>(<span class="number">250</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">set</span> @<span class="keyword">eventdata</span> = <span class="keyword">EVENTDATA</span>()</span><br><span class="line">	<span class="keyword">set</span> @orig_object_name = @eventdata.value(<span class="string">&#x27;(/EVENT_INSTANCE/ObjectName)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(100)&#x27;</span>)</span><br><span class="line">	<span class="keyword">set</span> @orig_user_name = <span class="keyword">upper</span>(@eventdata.value(<span class="string">&#x27;(/EVENT_INSTANCE/LoginName)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(25)&#x27;</span>))</span><br><span class="line">	<span class="keyword">set</span> @creaet_status = <span class="string">&#x27;Y&#x27;</span></span><br><span class="line">	<span class="keyword">set</span> @create_err_msg = <span class="string">&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">set</span> @alt_user_name = <span class="keyword">right</span>(@orig_user_name, <span class="keyword">len</span>(@orig_user_name) - <span class="keyword">charindex</span>(<span class="string">&#x27;\\&#x27;</span>, @orig_user_name))</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> @alt_user_name &lt;&gt; <span class="string">&#x27;domainName/yourServiceAccount&#x27;</span></span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> (<span class="keyword">select</span> * <span class="keyword">from</span> control_db.dbo.Audit_Sandbox_User <span class="keyword">where</span> User_ID = @alt_user_name)</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">set</span> @create_status = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">		<span class="keyword">set</span> @create_err_msg = <span class="string">&#x27;User: &#x27;</span> + @alt_user_name + <span class="string">&#x27; does not have privilege to use the sandbox database&#x27;</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">substring</span>(@orig_object_name, <span class="number">1</span>, <span class="keyword">len</span>(@alt_user_name)) &lt;&gt; @alt_user_name</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">set</span> @create_status = <span class="string">&#x27;N&#x27;</span></span><br><span class="line">		<span class="keyword">set</span> @create_err_msg = <span class="string">&#x27;user: &#x27;</span> + @alt_user_name + <span class="string">&#x27; does not have privilege to drop table: &#x27;</span> + @orig_object_name</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span> (@create_Status = <span class="string">&#x27;N&#x27;</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">rollback</span></span><br><span class="line">	print @create_err_msg</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">insert</span> control_db.dbo.Audit_Sandbox_Event_Tracking (Event_Type, Event_Time, Event_User, Event_Database, Event_Object_Name</span><br><span class="line">                                                       ,Event_Object_Type, Event_SQK, Audit_Created_Status, Audit_Error_Message)</span><br><span class="line">    	<span class="keyword">value</span> (@eventdata.value(<span class="string">&#x27;(/EVENT_INSTANCE/EventType)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(50)&#x27;</span>),</span><br><span class="line">               @eventdata.value(<span class="string">&#x27;(/EVENT_INSTANCE/PostTime)[1]&#x27;</span>,<span class="string">&#x27;datetime&#x27;</span>),</span><br><span class="line">               @Orig_user_name,</span><br><span class="line">               @eventdata.value(<span class="string">&#x27;(EVENT_INSTANCE/DatabaseName)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(25)&#x27;</span>),</span><br><span class="line">               @orig_object_name,</span><br><span class="line">               @eventdata.value(<span class="string">&#x27;(/EVENT_INSTANCE/ObjectType)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(25)&#x27;</span>),</span><br><span class="line">               @eventdata.value(<span class="string">&#x27;(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]&#x27;</span>,<span class="string">&#x27;nvarchar(max)&#x27;</span>),</span><br><span class="line">               <span class="keyword">case</span> <span class="keyword">when</span> @create_status = <span class="string">&#x27;Y&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;success&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;failed&#x27;</span> <span class="keyword">end</span>,</span><br><span class="line">               @create_err_msg</span><br><span class="line">              )</span><br><span class="line"><span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<p>At last, one very important setting need to be in placed in case cause issue when  [sa] user cross database reference data</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> sandbox <span class="keyword">set</span> TRUSTWORTHY <span class="keyword">ON</span>;</span><br></pre></td></tr></table></figure>

<p>about trustworthy for detail, you can see Microsoft official document on below link</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/relational-databases/security/trustworthy-database-property?view=sql-server-ver15">Trustworthy database property</a></p>

        
    </section>
</article>



<a id="pagenext" href="/2020/11/30/A-little-thought-on-SQL-query-performance-optimization-1/" class="article-next" title="A little thought on SQL query performance optimization 1"><i class="icon-arrow-right"></i></a>


<a id="pageprev" href="/2020/12/07/Generate-non-comma-delimiter-CSV-file/" class="article-prev" title="Generate non comma delimiter CSV file"><i class="icon-arrow-left"></i></a>




            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
</footer>

    </main>

    <script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle('normal', slideDone);
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp('normal', slideDone);
            }, 3000);
        }

        function slideDone() {
            if (nodes.navInner.css('display') !== 'none') {
                nodes.navInner.css('display', '');
            }
        }

        $(window).on('resize', function() {
            if ($(this).width() > 960) {
                nodes.navInner.css('display', '');
            }
        });
    });
    </script>
    
        
<script src="/js/scrollspy.min.js"></script>

        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});

        $(window).on('resize', function() {
            var hw = $('#header').width();
            var ww = $('#wrapper').width();
            var space = ($(this).width() - hw - ww) / 2 / 2;

            var pageprev = $('#pageprev');
            var pagenext = $('#pagenext');
            var avg = (pageprev.width() + pagenext.width()) / 2

            if(space > avg) {
                var len = space - avg / 2;
                var styles = {position: 'fixed', top: '50%', marginTop: - (pageprev.width() + pagenext.width()) / 4}
                pageprev.css($.extend({left: hw + len}, styles));
                pagenext.css($.extend({right: len}, styles));
            } else {
                pageprev.removeAttr('style');
                pagenext.removeAttr('style');
            }
        }).trigger('resize');
        </script>
    

</body>
</html>
