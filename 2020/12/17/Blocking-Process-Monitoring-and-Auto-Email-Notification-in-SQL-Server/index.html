<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Blocking Process Monitoring and Auto Email Notification in SQL Server - Herman-blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Icaurs - Hexo Theme"><meta name="msapplication-TileImage" content="/img/favicon1.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Icaurs - Hexo Theme"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="From function perspective, to maintain a large scale business data warehouse is for making database system stable, robust and fast, which is a essential part to boost business team productivity and pe"><meta property="og:type" content="blog"><meta property="og:title" content="Blocking Process Monitoring and Auto Email Notification in SQL Server"><meta property="og:url" content="https://hermanteng19.github.io/2020/12/17/Blocking-Process-Monitoring-and-Auto-Email-Notification-in-SQL-Server/"><meta property="og:site_name" content="Herman-blog"><meta property="og:description" content="From function perspective, to maintain a large scale business data warehouse is for making database system stable, robust and fast, which is a essential part to boost business team productivity and pe"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://hermanteng19.github.io/img/blockingribbon.webp"><meta property="article:published_time" content="2020-12-18T02:54:30.000Z"><meta property="article:modified_time" content="2020-12-21T03:59:58.468Z"><meta property="article:author" content="Herman Teng"><meta property="article:tag" content="SQL Server, database, monitoring, system optimization"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/blockingribbon.webp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://hermanteng19.github.io/2020/12/17/Blocking-Process-Monitoring-and-Auto-Email-Notification-in-SQL-Server/"},"headline":"Herman-blog","image":[],"datePublished":"2020-12-18T02:54:30.000Z","dateModified":"2020-12-21T03:59:58.468Z","author":{"@type":"Person","name":"Herman Teng"},"description":"From function perspective, to maintain a large scale business data warehouse is for making database system stable, robust and fast, which is a essential part to boost business team productivity and pe"}</script><link rel="canonical" href="https://hermanteng19.github.io/2020/12/17/Blocking-Process-Monitoring-and-Auto-Email-Notification-in-SQL-Server/"><link rel="icon" href="/img/favicon1.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatar1.png" alt="Herman-blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/img/blockingribbon.webp" alt="Blocking Process Monitoring and Auto Email Notification in SQL Server"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-12-18T02:54:30.000Z" title="2020-12-18T02:54:30.000Z">2020-12-17</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-12-21T03:59:58.468Z" title="2020-12-21T03:59:58.468Z">2020-12-20</time></span><span class="level-item"><a class="link-muted" href="/categories/IT-BI/">IT, BI</a></span><span class="level-item">11 minutes read (About 1699 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Blocking Process Monitoring and Auto Email Notification in SQL Server</h1><div class="content"><p>From function perspective, to maintain a large scale business data warehouse is for making database system stable, robust and fast, which is a essential part to boost business team productivity and performance. However, for business users, the fundamental thing is <strong>data</strong>, so data can be delivered in high frequency and in time is the cornerstone for all business analysis and BI reporting. Obviously, the primary mandate for data management team is highly monitor ETL jobs to promise data process running well and smooth and never being blocked or corrupt by using process.</p>
<p>In this article, I am going to talk about how to build up a ETL job monitoring system to watch user query automatically in designed frequency. To accomplish this task, we need </p>
<ol>
<li>Create a view to collect user query in real time</li>
<li>Create a stored procedure to detect blocking in different situations</li>
<li>Create another stored procedure to handle the notification email sending</li>
<li>Create a console script to overall control the workflow</li>
</ol>
<a id="more"></a>

<p>to make clear with those step by a process workflow chart, we can easily to see the logic on behand the scene</p>
<p><img src="https://p.130014.xyz/2020/12/19/blockingworkflow.png" alt="blockingworkflow.png"></p>
<p>Firstly, SQL agent job is going to check blocking transaction every 30 minutes, if there are some user queries blocked ETL job execution service account, then check back database to determine if those transactions are new, if they are new then write into database <code>Blocking_Transaction</code> table and send email notification  to data management team to raise awareness; but if those blocking are not new, update <code>last_time</code> and <code>count</code> column in table then calculate if count number reach to 4 if yes, then send email to user and data management team.</p>
<h2 id="Create-a-view-to-collect-user-query-in-real-time"><a href="#Create-a-view-to-collect-user-query-in-real-time" class="headerlink" title="Create a view to collect user query in real time"></a>Create a view to collect user query in real time</h2><p> The first and most important thing for us is get the all transaction records against database so that we are able to know which user query transactions would block service account conduct ETL job. We need to utilize sys schema tables or dmv (dynamic management views) </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> controlDB;</span><br><span class="line">go</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> dbo.usrQueryMonioring</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> b.spid, c.DBName <span class="keyword">as</span> [DB_Name]</span><br><span class="line">    ,a.total_scheduled_time/<span class="number">1000</span> <span class="keyword">as</span> TotalScheTime_SS</span><br><span class="line">    ,a.total_scheduled_time/<span class="number">1000</span>/<span class="number">60</span> <span class="keyword">as</span> TotalScheTime_MM</span><br><span class="line">    ,a.total_elapsed_time/<span class="number">1000</span> <span class="keyword">as</span> TotalElapTime_SS</span><br><span class="line">    ,a.total_elapsed_time/<span class="number">1000</span>/<span class="number">60</span> <span class="keyword">as</span> TotalElapTime_MM</span><br><span class="line">    ,a.last_request_start_time</span><br><span class="line">    ,a.last_request_end_time</span><br><span class="line">    ,a.login_time</span><br><span class="line">    ,a.login_name</span><br><span class="line">    ,a.host_name</span><br><span class="line">    ,a.program_name</span><br><span class="line">    ,a.nt_domain</span><br><span class="line">    ,a.nt_user_name</span><br><span class="line">    ,a.status</span><br><span class="line">    ,a.is_user_process</span><br><span class="line">    ,b.blocked <span class="comment">--add blocking query information to quick locate the blocking transactions</span></span><br><span class="line">    ,b.cmd,</span><br><span class="line">    ,b.memusage*<span class="number">8</span> <span class="keyword">as</span> Memusage_KB</span><br><span class="line">    ,b.memusage*<span class="number">8</span>/<span class="number">1024</span> <span class="keyword">as</span> Memusage_MB</span><br><span class="line">    ,c.Query</span><br><span class="line">    <span class="keyword">from</span> master.sys.dm_exec_sessions a</span><br><span class="line">    <span class="keyword">join</span> master.sys.sysprocesses b</span><br><span class="line">    <span class="keyword">on</span> a.session_id=b.spid <span class="keyword">and</span> a.login_time=b.login_time</span><br><span class="line">    <span class="keyword">cross</span> <span class="keyword">apply</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">        <span class="keyword">from</span> master.sys.dm_exec_sql_text(b.sql_handle)</span><br><span class="line">    ) c</span><br><span class="line">    <span class="keyword">where</span> a.is_user_process=<span class="number">1</span> <span class="comment">--consider spids for user only, no system spids</span></span><br><span class="line">    <span class="keyword">and</span> a.session_id!=@@SPID <span class="comment">--don&#x27;t include request from current spid</span></span><br><span class="line">),</span><br><span class="line">t2 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    spid</span><br><span class="line">    ,DB_Name</span><br><span class="line">    ,TotalScheTime_SS</span><br><span class="line">    ,TotalScheTime_MM</span><br><span class="line">    ,TotalElapTime_SS</span><br><span class="line">    ,TotalElapTime_MM</span><br><span class="line">    ,blocked <span class="keyword">as</span> BlockedBy</span><br><span class="line">    ,last_request_start_tiem</span><br><span class="line">    ,last_request_end_time</span><br><span class="line">    ,login_time</span><br><span class="line">    ,login_name</span><br><span class="line">    ,<span class="keyword">case</span> <span class="keyword">when</span> host_name <span class="keyword">like</span> <span class="string">&#x27;your server name%&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;Server&#x27;</span></span><br><span class="line">    <span class="keyword">else</span> <span class="string">&#x27;Client&#x27;</span> <span class="keyword">end</span> <span class="keyword">as</span> <span class="string">&#x27;Host Name&#x27;</span></span><br><span class="line">    ,<span class="keyword">case</span> <span class="keyword">when</span> program_name <span class="keyword">like</span> <span class="string">&#x27;Microsoft SQL Server Mangement Studio%&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;SQL Query&#x27;</span></span><br><span class="line">    <span class="keyword">when</span> program_name <span class="keyword">like</span> <span class="string">&#x27;Python&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;Python Access&#x27;</span></span><br><span class="line">    <span class="keyword">else</span> <span class="string">&#x27;Server general job or data provider&#x27;</span> <span class="keyword">end</span> <span class="keyword">as</span> <span class="string">&#x27;Program Name&#x27;</span></span><br><span class="line">    ,nt_domain</span><br><span class="line">    ,nt_user_name</span><br><span class="line">    ,<span class="keyword">status</span></span><br><span class="line">    ,<span class="keyword">case</span> is_user_process <span class="keyword">when</span> <span class="number">0</span> <span class="keyword">then</span> <span class="string">&#x27;SA System&#x27;</span></span><br><span class="line">    <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;User Initiate&#x27;</span> <span class="keyword">end</span> <span class="keyword">as</span> <span class="string">&#x27;Is_User_Process&#x27;</span></span><br><span class="line">    ,cmd</span><br><span class="line">    ,Memusage_KB</span><br><span class="line">    ,<span class="keyword">Query</span></span><br><span class="line">    <span class="keyword">from</span> t1</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> t2</span><br><span class="line">;</span><br><span class="line">go</span><br></pre></td></tr></table></figure>

<p>Before moving forward, we need a middle table to store all service account blocking transaction records </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> controlDB;</span><br><span class="line">go</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dbo.blocking_transaction</span><br><span class="line">(</span><br><span class="line">TraceID <span class="built_in">int</span> <span class="keyword">identity</span>(<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    ,spid <span class="built_in">smallint</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    ,blokedBy</span><br><span class="line">    ,login_name <span class="keyword">nvarchar</span>(<span class="number">128</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    ,nt_user_name <span class="keyword">nvarchar</span>(<span class="number">128</span>) <span class="literal">null</span></span><br><span class="line">    ,TotalElapTime_MM <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    ,ps_time datetime <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    ,fr_Time datetime <span class="keyword">not</span> <span class="literal">null</span> <span class="comment">--first record time</span></span><br><span class="line">    ,lr_Time datetime <span class="keyword">not</span> <span class="literal">null</span> <span class="comment">--last record time</span></span><br><span class="line">    ,counter <span class="built_in">smallint</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    ,cmd <span class="keyword">nchar</span>(<span class="number">16</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    ,<span class="keyword">query</span> <span class="built_in">varchar</span>(<span class="keyword">max</span>) <span class="literal">null</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h2 id="Create-a-stored-procedure-to-detect-blocking-in-different-situations"><a href="#Create-a-stored-procedure-to-detect-blocking-in-different-situations" class="headerlink" title="Create a stored procedure to detect blocking in different situations"></a>Create a stored procedure to detect blocking in different situations</h2><p>Next we will apply the main logics to detect service account blocking transactions in terms of different scenarios when we have the query transaction records data. In this time, we need to create a stored procedure to be executed by SQL job.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> proc dbo.usp_blocking_trans (@counter <span class="built_in">smallint</span> <span class="keyword">output</span>, @rowcnt <span class="built_in">int</span> <span class="keyword">output</span>)</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">if</span> OBJECT_ID(N<span class="string">&#x27;tempdb..#blked&#x27;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="comment">#blked</span></span><br><span class="line">;</span><br><span class="line"><span class="keyword">declare</span> @row_cnt <span class="built_in">int</span></span><br><span class="line"><span class="keyword">declare</span> @sSQL <span class="keyword">nvarchar</span>(<span class="keyword">max</span>)</span><br><span class="line"><span class="keyword">declare</span> @sParam <span class="keyword">nvarchar</span>(<span class="number">4</span>)</span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> spid, BlockedBy, login_name, nt_user_name, TotalElapTime_in_MM,last_request_start_time,cmd,<span class="keyword">query</span></span><br><span class="line">    <span class="keyword">from</span> controlDB.dbo.usrQueryMonioring</span><br><span class="line">    <span class="keyword">where</span> BlockedBy!=<span class="number">0</span> <span class="keyword">and</span> login_name=<span class="string">&#x27;your service account&#x27;</span></span><br><span class="line">),t2 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> spid, BlockedBy, login_name, nt_user_name, TotalElapTime_in_MM,last_request_start_time,cmd,<span class="keyword">query</span></span><br><span class="line">    <span class="keyword">from</span> t1</span><br><span class="line">    <span class="keyword">except</span></span><br><span class="line">    <span class="keyword">select</span> spid, BlockedBy, </span><br><span class="line">    login_name, nt_user_name, TotalElapTime_in_MM,last_request_start_time,cmd,<span class="keyword">query</span></span><br><span class="line">    <span class="keyword">from</span> t1 a <span class="keyword">join</span> t1 b</span><br><span class="line">    <span class="keyword">on</span> a.spid=b.BlockedBy <span class="comment">--remove duplicates</span></span><br><span class="line">),t3 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> spid, BlockedBy, login_name, nt_user_name, TotalElapTime_in_MM,last_request_start_time,cmd,<span class="keyword">query</span></span><br><span class="line">    <span class="keyword">from</span> controlDB.dbo.usrQueryMonioring</span><br><span class="line">    <span class="keyword">where</span> spid <span class="keyword">in</span> (<span class="keyword">select</span> BlockedBy <span class="keyword">from</span> t2) <span class="comment">-- in operator to hold potential multiple transactions</span></span><br><span class="line">),t4 <span class="keyword">as</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> t2</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> *</span><br><span class="line">    <span class="keyword">from</span> t3</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">into</span> <span class="comment">#blked</span></span><br><span class="line"><span class="keyword">from</span> t4</span><br><span class="line"><span class="comment">/*return 1 if no record in temp table*/</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span>(<span class="keyword">select</span> * <span class="keyword">from</span> <span class="comment">#blked)</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">print <span class="string">&#x27;no record in temp table&#x27;</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">/*check for incremental load*/</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">select</span> @row_cnt=<span class="keyword">count</span>(a.spid)</span><br><span class="line"><span class="keyword">from</span> <span class="comment">#blked a left join controlDB.dbo.blocking_transaction b</span></span><br><span class="line"><span class="keyword">on</span> a.spid=b.spid <span class="keyword">and</span> a.last_request_start_time=b.ps_time</span><br><span class="line"><span class="keyword">where</span> b.spid <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">and</span> b.ps_time <span class="keyword">is</span> <span class="literal">null</span></span><br><span class="line">;</span><br><span class="line">if @row_cnt&gt;=1</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @sSQL=N<span class="string">&#x27;</span></span><br><span class="line"><span class="string">insert into dbo.blocking_transaction</span></span><br><span class="line"><span class="string">select a.spid,a.BlockedBy,a.login_name,a.nt_user_name,</span></span><br><span class="line"><span class="string">a.TotalElapTime_MM,a.last_request_start_time,getdate(),getdate(),1,a.cmd,a.query</span></span><br><span class="line"><span class="string">from #blked a</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line">exec sp_executesql @sSQL</span><br><span class="line"><span class="keyword">select</span> @rowcnt=@@ROWCOUNT <span class="comment">--output number of row inserted</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">/*update the old records on last_record_time and count if counter&gt;=3*/</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">select</span> top(<span class="number">1</span>) @counter = counter <span class="keyword">from</span> controlDB.dbo.blocking_transaction <span class="keyword">order</span> <span class="keyword">by</span> lr_time <span class="keyword">desc</span></span><br><span class="line">;</span><br><span class="line"><span class="keyword">update</span> a </span><br><span class="line"><span class="keyword">set</span> lr_time=<span class="keyword">getdate</span>(),counter=@counter+<span class="number">1</span></span><br><span class="line"><span class="keyword">from</span> blocking_transaction a <span class="keyword">inner</span> <span class="keyword">join</span> <span class="comment">#blked b</span></span><br><span class="line"><span class="keyword">on</span> a.spid=b.spid <span class="keyword">and</span> a.ps_time=b.last_reqeust_start_time</span><br><span class="line">;</span><br><span class="line">if (<span class="keyword">select</span> top(<span class="number">1</span>) counter <span class="keyword">from</span> blocking _transaction <span class="keyword">order</span> <span class="keyword">by</span> lr_time <span class="keyword">desc</span>)%<span class="number">4</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">3</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">4</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="comment">#blked</span></span><br><span class="line"><span class="keyword">begin</span> catch</span><br><span class="line"><span class="keyword">declare</span> @err_msg <span class="keyword">nvarchar</span>(<span class="number">1000</span>),@err_num <span class="built_in">int</span>,@err_line <span class="built_in">int</span>,@syserr <span class="keyword">nvarchar</span>(<span class="number">1000</span>)</span><br><span class="line"><span class="keyword">select</span> @err_msg=ERROR_MESSAGE(),@err_num=ERROR_NUMBER(),@err_line=ERROR_LINE()</span><br><span class="line"><span class="keyword">SET</span> @syserr=N<span class="string">&#x27;usp_blocking_trans ended with error: </span></span><br><span class="line"><span class="string">Line=&#x27;</span>+<span class="keyword">convert</span>(<span class="keyword">nvarchar</span>(<span class="number">3</span>),@err_line)+<span class="string">&#x27;, Error_Msg=&#x27;</span>+@err_msg+<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">end</span> catch</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="Create-another-stored-procedure-to-handle-the-notification-email-sending"><a href="#Create-another-stored-procedure-to-handle-the-notification-email-sending" class="headerlink" title="Create another stored procedure to handle the notification email sending"></a>Create another stored procedure to handle the notification email sending</h2><p>Sending email to raise awareness is another important task for the entire monitoring system, in this case there are two server levels, if user query blocking time less than 4 (4*30=120 mins) only email to data management team, otherwise, email to both data management team and user to cancel the transaction. If user ignores then data management team would do something to clear the lock by policy.</p>
<p>we use parameters output from stored procedure <code>usp_blocking_trans</code> as input to be the key conditions</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> controlDB;</span><br><span class="line">go</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> dbo.usp_blocking_Email</span><br><span class="line">(</span><br><span class="line">	@<span class="keyword">case</span> <span class="built_in">smallint</span>,</span><br><span class="line">    @times <span class="built_in">smallint</span>,</span><br><span class="line">    @<span class="keyword">rownum</span> <span class="built_in">int</span> <span class="comment">--handle multiple blocking case</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span> try</span><br><span class="line"><span class="keyword">declare</span> @<span class="keyword">result</span> <span class="built_in">int</span></span><br><span class="line"><span class="keyword">declare</span> @runtime <span class="keyword">nvarchar</span>(<span class="number">20</span>)</span><br><span class="line"><span class="keyword">declare</span> @subject <span class="keyword">nvarchar</span>(<span class="number">500</span>)</span><br><span class="line"><span class="keyword">declare</span> @sSQL <span class="keyword">nvarchar</span>(<span class="number">200</span>)</span><br><span class="line"><span class="keyword">declare</span> @sParam <span class="keyword">nvarchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">declare</span> @spid <span class="keyword">nvarchar</span>(<span class="number">4</span>)</span><br><span class="line"><span class="keyword">declare</span> @<span class="keyword">body</span> <span class="keyword">nvarchar</span>(<span class="keyword">max</span>)</span><br><span class="line"><span class="keyword">declare</span> @counter <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @runtime=<span class="keyword">convert</span>(<span class="keyword">nvarchar</span>,<span class="keyword">GETDATE</span>())</span><br><span class="line"><span class="keyword">set</span> @sSQL=N<span class="string">&#x27;select top 1 @bID=blockedBy from controlDB.dbo.blocking_transaction where </span></span><br><span class="line"><span class="string">nt_user_name=&#x27;&#x27;your service account&#x27;&#x27; and blockedBy!=0 by tranceID desc&#x27;</span></span><br><span class="line"><span class="keyword">set</span> @sParam=N<span class="string">&#x27;@bID nvarchar(4) output&#x27;</span></span><br><span class="line">exec sp_executesql @sSQL, @sParam, @bId=spid <span class="keyword">output</span></span><br><span class="line"><span class="keyword">set</span> @subject=N<span class="string">&#x27;Warning: ETL job being blocked </span></span><br><span class="line"><span class="string">on &#x27;</span>+@runtime+N<span class="string">&#x27;by SPID&#x27;</span>+@spid+N<span class="string">&#x27;, check it out!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> @<span class="keyword">case</span>=<span class="number">2</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">body</span>=N<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&lt;p style=&quot;color:#000000;font-family: Georgia; font-size: 18px; line-height: 18px&quot;&gt;</span></span><br><span class="line"><span class="string">Hi Team,&lt;br /&gt;&lt;br /&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p style=&quot;color:#000000;font-family: Georgia; font-size: 18px; line-height: 18px&quot;&gt;</span></span><br><span class="line"><span class="string">A job is now being blocked by a user process with &lt;font color=&quot;#FF5733&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;b&gt;SPIS=&#x27;</span>+@spid+<span class="string">&#x27;&lt;/b&gt;&lt;/font&gt;&lt;br /&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="string">Please check [controlDB].dbo.[blocking_transaction] table.&lt;br /&gt;&lt;br /&gt;&lt;/i&gt;</span></span><br><span class="line"><span class="string">&lt;font size=&quot;4&quot;&gt;More details information shown on below&lt;/font&gt;&lt;br /&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="string">Thanks and Best Regards,&lt;br /&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="string">&lt;/p&gt;&#x27;</span>+</span><br><span class="line">N<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">	th</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		background: #33FFBD</span></span><br><span class="line"><span class="string">		height: 30px;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">	table,th,td</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		border: 2px solid green;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">	table</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		width: 80%;</span></span><br><span class="line"><span class="string">		color: black;</span></span><br><span class="line"><span class="string">		text-align: center;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;&#x27;</span>+</span><br><span class="line">	N<span class="string">&#x27;&lt;h2&gt;&lt;center&gt;&lt;font color=&quot;red&quot;&gt;ETL Job Info for Blocking&lt;/font&gt;&lt;/center&gt;&lt;/h2&gt;&#x27;</span>+</span><br><span class="line">	N<span class="string">&#x27;&lt;table align=&quot;center&quot;&gt;&#x27;</span> +</span><br><span class="line">	N<span class="string">&#x27;&lt;tr&gt;&#x27;</span>+</span><br><span class="line">	N<span class="string">&#x27;&lt;th&gt;SPID&lt;/th&gt;&lt;th&gt;BLkdBY&lt;/th&gt;&#x27;</span> +</span><br><span class="line">	N<span class="string">&#x27;&lt;th&gt;User Name&lt;/th&gt;&#x27;</span> +</span><br><span class="line">	N<span class="string">&#x27;&lt;th&gt;Elapse Time in MM&lt;/th&gt;&lt;th&gt;Process Run Time&lt;/th&gt;&#x27;</span> +</span><br><span class="line">	N<span class="string">&#x27;&lt;th&gt;First Record Time&lt;/th&gt;&lt;th&gt;Last Record Time&lt;/th&gt;&#x27;</span> +</span><br><span class="line">	N<span class="string">&#x27;&lt;th&gt;Counter&lt;/th&gt;&lt;th&gt;CMD&lt;/th&gt;&#x27;</span> +</span><br><span class="line">	N<span class="string">&#x27;&lt;/tr&gt;&#x27;</span> +</span><br><span class="line">	<span class="keyword">cast</span>((</span><br><span class="line">    	<span class="keyword">select</span> top (@<span class="keyword">rownum</span>)</span><br><span class="line">        td=[spid],<span class="string">&#x27;&#x27;</span></span><br><span class="line">        ,td=[blockedBy],<span class="string">&#x27;&#x27;</span></span><br><span class="line">        ,td=[nt_user_name],<span class="string">&#x27;&#x27;</span></span><br><span class="line">        ,td=[TotalElapTime_in_MM],<span class="string">&#x27;&#x27;</span></span><br><span class="line">        ,td=[ps_time],<span class="string">&#x27;&#x27;</span></span><br><span class="line">        ,td=[fr_time],<span class="string">&#x27;&#x27;</span></span><br><span class="line">        ,td=[lr_time],<span class="string">&#x27;&#x27;</span></span><br><span class="line">        ,td=[counter],<span class="string">&#x27;&#x27;</span></span><br><span class="line">        ,td=[cmd],<span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">from</span> controlDB.dbo.blocking_transaction</span><br><span class="line">        <span class="keyword">order</span> <span class="keyword">by</span> TranceID <span class="keyword">desc</span></span><br><span class="line">        <span class="keyword">FOR</span> <span class="keyword">XML</span> <span class="keyword">PATH</span>(<span class="string">&#x27;tr&#x27;</span>), <span class="keyword">TYPE</span></span><br><span class="line">    ) <span class="keyword">as</span> <span class="keyword">nvarchar</span>(<span class="keyword">max</span>)) +</span><br><span class="line">N<span class="string">&#x27;&lt;/table&gt;&#x27;</span> +</span><br><span class="line">N<span class="string">&#x27;&lt;p&gt;&lt;br /&gt;&lt;/p&gt;&#x27;</span> +</span><br><span class="line">N<span class="string">&#x27;your team name&#x27;</span></span><br><span class="line">;</span><br><span class="line">else</span><br><span class="line">if @case=3</span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">body</span>=N<span class="string">&#x27;</span></span><br><span class="line"><span class="string">&lt;p&gt;&lt;br /&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p style=&quot;color:#000000;font-family: Georgia; font-size: 18px; line-height: 18px&quot;&gt;Hi Team,&lt;br /&gt;&lt;br /&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">A ETL job is now still being blocked by a user process with </span></span><br><span class="line"><span class="string">spid=&#x27;</span>+@spdi+<span class="string">&#x27; for more than &#x27;</span>+@times+<span class="string">&#x27; checks adn &#x27;</span>+@times*<span class="number">30</span>+<span class="string">&#x27; minutes</span></span><br><span class="line"><span class="string">check previous email or controlDB.dbo.blocking_transaction table for more details!</span></span><br><span class="line"><span class="string">&lt;br /&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="string">your team name</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line"><span class="keyword">execute</span> @<span class="keyword">result</span>=msdb.dbo.sp_send_dbmail</span><br><span class="line">@profile_name=N<span class="string">&#x27;your SMTP profile name&#x27;</span>,</span><br><span class="line">@recipients = N<span class="string">&#x27;email1@yourcompany.com;email2@yourcompany.com&#x27;</span>,</span><br><span class="line">@copy_recipients = N<span class="string">&#x27;email3@yourcompany.com&#x27;</span>,</span><br><span class="line">@subject = @subject,</span><br><span class="line">@<span class="keyword">body</span> = @<span class="keyword">body</span>,</span><br><span class="line">@body_format=<span class="string">&#x27;HTML&#x27;</span></span><br><span class="line">;</span><br><span class="line">return 0</span><br><span class="line"><span class="keyword">end</span> try</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="Create-a-console-script-to-overall-control-the-workflow"><a href="#Create-a-console-script-to-overall-control-the-workflow" class="headerlink" title="Create a console script to overall control the workflow"></a>Create a console script to overall control the workflow</h2><p>at the last step, we need a control script put all above stored procedure together to be able to schedule <code>SQL Agent</code> job.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> controlDB;</span><br><span class="line">go</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> @result_status <span class="built_in">smallint</span></span><br><span class="line"><span class="keyword">declare</span> @counter <span class="built_in">smallint</span></span><br><span class="line"><span class="keyword">declare</span> @rowcnt <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">exec @result_status=usp_blocking_trans @counter=@counter <span class="keyword">output</span>, @rowcnt=@rowcnt <span class="keyword">output</span></span><br><span class="line"><span class="keyword">if</span> @result_status=<span class="number">1</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">print(<span class="string">&#x27;no blocking process&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">if</span> @result_status=<span class="number">4</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">print(<span class="string">&#x27;no new blocking process&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> @counter=@counter+<span class="number">1</span></span><br><span class="line">exec usp_blocked_Email @<span class="keyword">case</span>=@result_status, @times=@counter, @<span class="keyword">rownum</span>=rowcnt</span><br></pre></td></tr></table></figure>









</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/SQL-Server-database-monitoring-system-optimization/">SQL Server, database, monitoring, system optimization</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/12/20/Data-Manipulation-and-ETL-with-Pandas/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Data Manipulation and ETL with Pandas</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/12/15/Automation-Process-for-Email-Attachment-Excel-in-Python/"><span class="level-item">Automation Process for Email Attachment Excel in Python</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://hermanteng19.github.io/2020/12/17/Blocking-Process-Monitoring-and-Auto-Email-Notification-in-SQL-Server/';
            this.page.identifier = '2020/12/17/Blocking-Process-Monitoring-and-Auto-Email-Notification-in-SQL-Server/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'herman-hexo-blog' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar1.png" alt="Herman"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Herman</p><p class="is-size-6 is-block">Data Analyst&amp;Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Toronto, Canada</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">13</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">13</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/HermanTeng19" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/HermanTeng19"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Create-a-view-to-collect-user-query-in-real-time"><span class="level-left"><span class="level-item">1</span><span class="level-item">Create a view to collect user query in real time</span></span></a></li><li><a class="level is-mobile" href="#Create-a-stored-procedure-to-detect-blocking-in-different-situations"><span class="level-left"><span class="level-item">2</span><span class="level-item">Create a stored procedure to detect blocking in different situations</span></span></a></li><li><a class="level is-mobile" href="#Create-another-stored-procedure-to-handle-the-notification-email-sending"><span class="level-left"><span class="level-item">3</span><span class="level-item">Create another stored procedure to handle the notification email sending</span></span></a></li><li><a class="level is-mobile" href="#Create-a-console-script-to-overall-control-the-workflow"><span class="level-left"><span class="level-item">4</span><span class="level-item">Create a console script to overall control the workflow</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatar1.png" alt="Herman-blog" height="28"></a><p class="is-size-7"><span>&copy; 2020 Herman Teng</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>