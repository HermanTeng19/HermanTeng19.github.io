<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>SQL Server Table Partitioning in Large Scale Data Warehouse 1 - Herman-blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Icaurs - Hexo Theme"><meta name="msapplication-TileImage" content="/img/favicon1.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Icaurs - Hexo Theme"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="This is a series articles to demonstrate table partitioning technology and how to apply it in a large scale data warehouse to improve database performance and even benefit for maintenance operation ba"><meta property="og:type" content="blog"><meta property="og:title" content="SQL Server Table Partitioning in Large Scale Data Warehouse 1"><meta property="og:url" content="https://hermanteng19.github.io/2020/12/25/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-1/"><meta property="og:site_name" content="Herman-blog"><meta property="og:description" content="This is a series articles to demonstrate table partitioning technology and how to apply it in a large scale data warehouse to improve database performance and even benefit for maintenance operation ba"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://hermanteng19.github.io/img/tablepartitionribbon1.jpg"><meta property="article:published_time" content="2020-12-26T02:20:12.000Z"><meta property="article:modified_time" content="2023-07-05T01:39:57.233Z"><meta property="article:author" content="Herman Teng"><meta property="article:tag" content="SQL Server"><meta property="article:tag" content="partitioning"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/tablepartitionribbon1.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://hermanteng19.github.io/2020/12/25/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-1/"},"headline":"Herman-blog","image":["https://hermanteng19.github.io/img/tablepartitionribbon1.jpg"],"datePublished":"2020-12-26T02:20:12.000Z","dateModified":"2023-07-05T01:39:57.233Z","author":{"@type":"Person","name":"Herman Teng"},"description":"This is a series articles to demonstrate table partitioning technology and how to apply it in a large scale data warehouse to improve database performance and even benefit for maintenance operation ba"}</script><link rel="canonical" href="https://hermanteng19.github.io/2020/12/25/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-1/"><link rel="icon" href="/img/favicon1.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatar1.png" alt="Herman-blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/img/tablepartitionribbon1.jpg" alt="SQL Server Table Partitioning in Large Scale Data Warehouse 1"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-12-26T02:20:12.000Z" title="2020-12-26T02:20:12.000Z">2020-12-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-07-05T01:39:57.233Z" title="2023-07-05T01:39:57.233Z">2023-07-04</time></span><span class="level-item"><a class="link-muted" href="/categories/Database/">Database</a><span> / </span><a class="link-muted" href="/categories/Database/BI/">BI</a></span><span class="level-item">36 minutes read (About 5428 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">SQL Server Table Partitioning in Large Scale Data Warehouse 1</h1><div class="content"><p>This is a series articles to demonstrate table partitioning technology and how to apply it in a large scale data warehouse to improve database performance and even benefit for maintenance operation based on Microsoft SQL Server. This series is composed by three parts</p>
<ol>
<li>The first one is a fundamental introduction on basis knowledge</li>
<li>The second part is showcase the entire production workflow to apply table partitioning to large tables</li>
<li>Finally, it’s going to be advanced topic like partition merge, split, conversion and performance optimization in terms of different business demands</li>
</ol>
<h2 id="Table-Partitioning-The-Basics"><a href="#Table-Partitioning-The-Basics" class="headerlink" title="Table Partitioning The Basics"></a><em>Table Partitioning The Basics</em></h2><p>For this part, I will reference Cathrine Wilhelmsen’s work, she is  Microsoft Data Platform MVP, BimlHero Certified Expert, international speaker, author, blogger, and chronic volunteer. She loves data and coding, as well as teaching and sharing knowledge - oh, and sci-fi, chocolate, coffee, and cats :)</p>
<p>I learnt a lot and got many ideas from her blogs especially for table partitioning technology, below is her blog address, hope it can help you as well:blush:</p>
<p><strong><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/">Cathrine blog</a></strong></p>
<a id="more"></a>

<p>This post is part 1 of 2 in the series <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/series/table-partitioning-in-sql-server/">Table Partitioning in SQL Server</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/SQLServerTablePartitioningCheatSheet.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/SQLServerTablePartitioningCheatSheet-200x172.png" alt="SQL Server Table Partitioning Cheat Sheet"></a></p>
<p>There are many benefits of partitioning large tables. You can speed up loading and archiving of data, you can perform maintenance operations on individual partitions instead of the whole table, and you may be able to improve query performance. However, implementing table partitioning is not a trivial task and you need a good understanding of how it works to implement and use it correctly.</p>
<p>Being a business intelligence and data warehouse developer, not a DBA, it took me a while to understand table partitioning. I had to read a lot, get plenty of hands-on experience and make some mistakes along the way. (<em>The illustration to the left is my Table Partitioning Cheat Sheet.</em>) One of my favorite ways to learn something is to figure out how to explain it to others, so I recently did a <a target="_blank" rel="noopener" href="https://pragmaticworks.com/Training/Details/Webinar-1743">webinar about table partitioning</a>. (<em>Update in 2020: The webinar has now been archived. Please contact <a target="_blank" rel="noopener" href="https://www.pragmaticworks.com/">Pragmatic Works</a> if you would like to watch it, as they are the owners and publishers.</em>) I wanted to follow that up with focused blog posts that included answers to questions I received during the webinar. This post covers the <em>basics</em> of partitioned tables, partition columns, partition functions and partition schemes.</p>
<h2 id="What-is-Table-Partitioning"><a href="#What-is-Table-Partitioning" class="headerlink" title="What is Table Partitioning?"></a>What is Table Partitioning?</h2><p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionedTable.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionedTable-200x200.png" alt="Partitioned Table"></a></p>
<p>Table partitioning is a way to divide a large table into smaller, more manageable parts without having to create separate tables for each part. Data in a partitioned table is physically stored in groups of rows called <em>partitions</em> and each partition can be accessed and maintained separately. Partitioning is not visible to end users, a partitioned table behaves like one logical table when queried.</p>
<p>This example illustration is used throughout this blog post to explain basic concepts. The table contains data from every day in 2012, 2013, 2014 and 2015, and there is one partition per year. To simplify the example, only the first and last day in each year is shown.</p>
<p>An alternative to partitioned tables (for those who don’t have Enterprise Edition) is to create separate tables for each group of rows, union the tables in a view and then query the view instead of the tables. This is called a <em>partitioned view</em>. (Partitioned views are not covered in this blog post.)</p>
<h2 id="What-is-a-Partition-Column"><a href="#What-is-a-Partition-Column" class="headerlink" title="What is a Partition Column?"></a>What is a Partition Column?</h2><p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionKey.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionKey-200x200.png" alt="Partition Column (Partition Key)"></a></p>
<p>Data in a partitioned table is partitioned based on a single column, the partition column, often called the <em>partition key</em>. Only one column can be used as the partition column, but it is possible to use a computed column.</p>
<p>In the example illustration the date column is used as the partition column. SQL Server places rows in the correct partition based on the values in the date column. All rows with dates before or in 2012 are placed in the first partition, all rows with dates in 2013 are placed in the second partition, all rows with dates in 2014 are placed in the third partition, and all rows with dates in 2015 or after are placed in the fourth partition. If the partition column value is NULL, the rows are placed in the first partition.</p>
<p>It is important to select a partition column that is almost always used as a filter in queries. When the partition column is used as a filter in queries, SQL Server can access only the relevant partitions. This is called <em>partition elimination</em> and can greatly improve performance when querying large tables.</p>
<h2 id="What-is-a-Partition-Function"><a href="#What-is-a-Partition-Function" class="headerlink" title="What is a Partition Function?"></a>What is a Partition Function?</h2><p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction-200x183.png" alt="Partition Function"></a></p>
<p>The partition function defines how to partition data based on the partition column. The partition function does not explicitly define the partitions and which rows are placed in each partition. Instead, the partition function specifies <em>boundary values</em>, the points <em>between</em> partitions. The total number of partitions is always the total number of boundary values + 1.</p>
<p>In the example illustration there are three boundary values. The first boundary value is between 2012 and 2013, the second boundary value is between 2013 and 2014, and the third boundary value is between 2014 and 2015. The three boundary values create four partitions. (The first partition also includes all rows with dates before 2012 and the last partition also includes all rows after 2015, but the example is kept simple with only four years for now.)</p>
<p>But what are the actual boundary values used in the example? How do you know which date values are the points <em>between</em> two years? Is it December 31st or January 1st? The answer is that it can actually be either December 31st or January 1st, it depends on whether you use a <em>range left</em> or a <em>range right</em> partition function.</p>
<h3 id="Range-Left-and-Range-Right"><a href="#Range-Left-and-Range-Right" class="headerlink" title="Range Left and Range Right"></a>Range Left and Range Right</h3><p>Partition functions are created as either range left or range right to specify whether the boundary values belong to their left or right partitions:</p>
<ul>
<li>Range left means that the actual boundary value belongs to its left partition, it is the <em>last value in the left partition</em>.</li>
<li>Range right means that the actual boundary value belongs to its right partition, it is the <em>first value in the right partition</em>.</li>
</ul>
<p>Left and right partitions make more sense if the table is rotated:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction01.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction01-200x183.png" alt="Partition Function Range Left and Range Right"></a> → <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction02.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction02-200x183.png" alt="Partition Function Range Left and Range Right"></a> → <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction03.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction03-183x200.png" alt="Partition Function Range Left and Range Right"></a></p>
<h3 id="Range-Left-and-Range-Right-using-Dates"><a href="#Range-Left-and-Range-Right-using-Dates" class="headerlink" title="Range Left and Range Right using Dates"></a>Range Left and Range Right using Dates</h3><p>The first boundary value is between 2012 and 2013. This can be created in two ways, either by specifying a range left partition function with December 31st as the boundary value, or as a range right partition function with January 1st as the boundary value:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction04.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction04-183x200.png" alt="Partition Function Range Left and Range Right"></a> → <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction05.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction05-183x200.png" alt="Partition Function Range Left and Range Right"></a> → <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction06.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction06-183x200.png" alt="Partition Function Range Left and Range Right"></a></p>
<p>Partition functions are created as either range left or range right, it is not possible to combine both in the same partition function. In a range left partition function, all boundary values are <em>upper</em> boundaries, they are the last values in the partitions. If you partition by year, you use December 31st. If you partition by month, you use January 31st, February 28th / 29th, March 31st, April 30th and so on. In a range right partition function, all boundary values are <em>lower</em> boundaries, they are the first values in the partitions. If you partition by year, you use January 1st. If you partition by month, you use January 1st, February 1st, March 1st, April 1st and so on:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction07.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction07-183x200.png" alt="Partition Function Range Left and Range Right"></a> → <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction08.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction08-183x200.png" alt="Partition Function Range Left and Range Right"></a></p>
<h3 id="Range-Left-and-Range-Right-using-the-Wrong-Dates"><a href="#Range-Left-and-Range-Right-using-the-Wrong-Dates" class="headerlink" title="Range Left and Range Right using the Wrong Dates"></a>Range Left and Range Right using the <em>Wrong Dates</em></h3><p>If the wrong dates are used as boundary values, the partitions incorrectly span two time periods:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction10.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction10-183x200.png" alt="Partition Function Range Left and Range Right"></a> → <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction09.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionFunction09-183x200.png" alt="Partition Function Range Left and Range Right"></a></p>
<h2 id="What-is-a-Partition-Scheme"><a href="#What-is-a-Partition-Scheme" class="headerlink" title="What is a Partition Scheme?"></a>What is a Partition Scheme?</h2><p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionScheme.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionScheme-500x200.png" alt="Partition Scheme"></a></p>
<p>The partition scheme maps the logical partitions to physical filegroups. It is possible to map each partition to its own filegroup or all partitions to one filegroup.</p>
<p>A filegroup contains one or more data files that can be spread on one or more disks. Filegroups can be set to read-only, and filegroups can be backed up and restored individually. There are many benefits of mapping each partition to its own filegroup. Less frequently accessed data can be placed on slower disks and more frequently accessed data can be placed on faster disks. Historical, unchanging data can be set to read-only and then be excluded from regular backups. If data needs to be restored it is possible to restore the partitions with the most critical data first.</p>
<h2 id="How-do-I-create-a-Partitioned-Table"><a href="#How-do-I-create-a-Partitioned-Table" class="headerlink" title="How do I create a Partitioned Table?"></a>How do I create a Partitioned Table?</h2><p>The following script (for SQL Server 2012 and higher) first creates a numbers table function created by <a target="_blank" rel="noopener" href="https://www.itprotoday.com/sql-server/virtual-auxiliary-table-numbers">Itzik Ben-Gan</a> that is used to <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/2015/04/14/using-a-numbers-table-in-sql-server-to-insert-test-data/">insert test data</a>. The script then creates a partition function, a partition scheme and a partitioned table. (It is important to notice that this script is meant to demonstrate the basic concepts of table partitioning, it does not create any indexes or constraints and it maps all partitions to the [PRIMARY] filegroup. This script is not meant to be used in a real-world project.) Finally it inserts test data and shows information about the partitioned table.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* – ------------------------------------------------</span></span><br><span class="line"><span class="comment"> – Create helper function GetNums by Itzik Ben-Gan</span></span><br><span class="line"><span class="comment"> – https://www.itprotoday.com/sql-server/virtual-auxiliary-table-numbers</span></span><br><span class="line"><span class="comment"> – GetNums is used to insert test data</span></span><br><span class="line"><span class="comment">------------------------------------------------ – */</span></span><br><span class="line"></span><br><span class="line"> – <span class="keyword">Drop</span> helper <span class="keyword">function</span> <span class="keyword">if</span> it already <span class="keyword">exists</span></span><br><span class="line"><span class="keyword">IF</span> OBJECT_ID(<span class="string">&#x27;GetNums&#x27;</span>) <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">	<span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> GetNums;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"> – <span class="keyword">Create</span> helper <span class="keyword">function</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> GetNums(@n <span class="keyword">AS</span> <span class="built_in">BIGINT</span>) <span class="keyword">RETURNS</span> <span class="keyword">TABLE</span> <span class="keyword">AS</span> <span class="keyword">RETURN</span></span><br><span class="line">  <span class="keyword">WITH</span></span><br><span class="line">  L0   <span class="keyword">AS</span>(<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">AS</span> c <span class="keyword">UNION</span> <span class="keyword">ALL</span> <span class="keyword">SELECT</span> <span class="number">1</span>),</span><br><span class="line">  L1   <span class="keyword">AS</span>(<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">AS</span> c <span class="keyword">FROM</span> L0 <span class="keyword">AS</span> A <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> L0 <span class="keyword">AS</span> B),</span><br><span class="line">  L2   <span class="keyword">AS</span>(<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">AS</span> c <span class="keyword">FROM</span> L1 <span class="keyword">AS</span> A <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> L1 <span class="keyword">AS</span> B),</span><br><span class="line">  L3   <span class="keyword">AS</span>(<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">AS</span> c <span class="keyword">FROM</span> L2 <span class="keyword">AS</span> A <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> L2 <span class="keyword">AS</span> B),</span><br><span class="line">  L4   <span class="keyword">AS</span>(<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">AS</span> c <span class="keyword">FROM</span> L3 <span class="keyword">AS</span> A <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> L3 <span class="keyword">AS</span> B),</span><br><span class="line">  L5   <span class="keyword">AS</span>(<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">AS</span> c <span class="keyword">FROM</span> L4 <span class="keyword">AS</span> A <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> L4 <span class="keyword">AS</span> B),</span><br><span class="line">  Nums <span class="keyword">AS</span>(<span class="keyword">SELECT</span> ROW_NUMBER() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> (<span class="keyword">SELECT</span> <span class="literal">NULL</span>)) <span class="keyword">AS</span> n <span class="keyword">FROM</span> L5)</span><br><span class="line">  <span class="keyword">SELECT</span> TOP (@n) n <span class="keyword">FROM</span> Nums <span class="keyword">ORDER</span> <span class="keyword">BY</span> n;</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line"><span class="comment">/* – ----------------------------------------------------------</span></span><br><span class="line"><span class="comment"> – Create example Partitioned Table (Heap)</span></span><br><span class="line"><span class="comment"> – The Partition Column is a DATE column</span></span><br><span class="line"><span class="comment"> – The Partition Function is RANGE RIGHT</span></span><br><span class="line"><span class="comment"> – The Partition Scheme maps all partitions to [PRIMARY]</span></span><br><span class="line"><span class="comment">---------------------------------------------------------- – */</span></span><br><span class="line"></span><br><span class="line"> – <span class="keyword">Drop</span> objects <span class="keyword">if</span> they already exist</span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.tables <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;Sales&#x27;</span>)</span><br><span class="line">	<span class="keyword">DROP</span> <span class="keyword">TABLE</span> Sales;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.partition_schemes <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;psSales&#x27;</span>)</span><br><span class="line">	<span class="keyword">DROP</span> <span class="keyword">PARTITION</span> SCHEME psSales;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.partition_functions <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;pfSales&#x27;</span>)</span><br><span class="line">	<span class="keyword">DROP</span> <span class="keyword">PARTITION</span> <span class="keyword">FUNCTION</span> pfSales;</span><br><span class="line"></span><br><span class="line"> – <span class="keyword">Create</span> the <span class="keyword">Partition</span> <span class="keyword">Function</span> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PARTITION</span> <span class="keyword">FUNCTION</span> pfSales (<span class="built_in">DATE</span>)</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">RANGE</span> <span class="keyword">RIGHT</span> <span class="keyword">FOR</span> <span class="keyword">VALUES</span> </span><br><span class="line">(<span class="string">&#x27;2013-01-01&#x27;</span>, <span class="string">&#x27;2014-01-01&#x27;</span>, <span class="string">&#x27;2015-01-01&#x27;</span>);</span><br><span class="line"></span><br><span class="line"> – <span class="keyword">Create</span> the <span class="keyword">Partition</span> Scheme</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PARTITION</span> SCHEME psSales</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">PARTITION</span> pfSales </span><br><span class="line"><span class="keyword">ALL</span> <span class="keyword">TO</span> ([Primary]);</span><br><span class="line"></span><br><span class="line"> – <span class="keyword">Create</span> the Partitioned <span class="keyword">Table</span> (<span class="keyword">Heap</span>) <span class="keyword">on</span> the <span class="keyword">Partition</span> Scheme</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Sales (</span><br><span class="line">	SalesDate <span class="built_in">DATE</span>,</span><br><span class="line">	Quantity <span class="built_in">INT</span></span><br><span class="line">) <span class="keyword">ON</span> psSales(SalesDate);</span><br><span class="line"></span><br><span class="line"> – <span class="keyword">Insert</span> <span class="keyword">test</span> <span class="keyword">data</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Sales(SalesDate, Quantity)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DATEADD</span>(<span class="keyword">DAY</span>,dates.n<span class="number">-1</span>,<span class="string">&#x27;2012-01-01&#x27;</span>) <span class="keyword">AS</span> SalesDate, qty.n <span class="keyword">AS</span> Quantity</span><br><span class="line"><span class="keyword">FROM</span> GetNums(<span class="keyword">DATEDIFF</span>(DD,<span class="string">&#x27;2012-01-01&#x27;</span>,<span class="string">&#x27;2016-01-01&#x27;</span>)) dates</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span> GetNums(<span class="number">1000</span>) <span class="keyword">AS</span> qty;</span><br><span class="line"></span><br><span class="line"> – View Partitioned Table information</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">OBJECT_SCHEMA_NAME(pstats.object_id) <span class="keyword">AS</span> SchemaName</span><br><span class="line">,OBJECT_NAME(pstats.object_id) <span class="keyword">AS</span> TableName</span><br><span class="line">,ps.name <span class="keyword">AS</span> PartitionSchemeName</span><br><span class="line">,ds.name <span class="keyword">AS</span> PartitionFilegroupName</span><br><span class="line">,pf.name <span class="keyword">AS</span> PartitionFunctionName</span><br><span class="line">,<span class="keyword">CASE</span> pf.boundary_value_on_right <span class="keyword">WHEN</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="string">&#x27;Range Left&#x27;</span> <span class="keyword">ELSE</span> <span class="string">&#x27;Range Right&#x27;</span> <span class="keyword">END</span> <span class="keyword">AS</span> PartitionFunctionRange</span><br><span class="line">,<span class="keyword">CASE</span> pf.boundary_value_on_right <span class="keyword">WHEN</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="string">&#x27;Upper Boundary&#x27;</span> <span class="keyword">ELSE</span> <span class="string">&#x27;Lower Boundary&#x27;</span> <span class="keyword">END</span> <span class="keyword">AS</span> PartitionBoundary</span><br><span class="line">,prv.value <span class="keyword">AS</span> PartitionBoundaryValue</span><br><span class="line">,c.name <span class="keyword">AS</span> PartitionKey</span><br><span class="line">,<span class="keyword">CASE</span> </span><br><span class="line">	<span class="keyword">WHEN</span> pf.boundary_value_on_right = <span class="number">0</span> </span><br><span class="line">	<span class="keyword">THEN</span> c.name + <span class="string">&#x27; &gt; &#x27;</span> + </span><br><span class="line">	<span class="keyword">CAST</span>(<span class="keyword">ISNULL</span>(LAG(prv.value) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> pstats.object_id </span><br><span class="line">	<span class="keyword">ORDER</span> <span class="keyword">BY</span> pstats.object_id, pstats.partition_number), <span class="string">&#x27;Infinity&#x27;</span>) </span><br><span class="line">    <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>)) + <span class="string">&#x27; and &#x27;</span> + c.name + <span class="string">&#x27; &lt;= &#x27;</span> + <span class="keyword">CAST</span>(<span class="keyword">ISNULL</span>(prv.value, <span class="string">&#x27;Infinity&#x27;</span>) <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>)) </span><br><span class="line">	<span class="keyword">ELSE</span> c.name + <span class="string">&#x27; &gt;= &#x27;</span> </span><br><span class="line">	+ <span class="keyword">CAST</span>(<span class="keyword">ISNULL</span>(prv.value, <span class="string">&#x27;Infinity&#x27;</span>) <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>))  </span><br><span class="line">	+ <span class="string">&#x27; and &#x27;</span> + c.name + <span class="string">&#x27; &lt; &#x27;</span> </span><br><span class="line">	+ <span class="keyword">CAST</span>(<span class="keyword">ISNULL</span>(<span class="keyword">LEAD</span>(prv.value) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> pstats.object_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">pstats.object_id, pstats.partition_number), <span class="string">&#x27;Infinity&#x27;</span>) <span class="keyword">AS</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>))</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> PartitionRange</span><br><span class="line">	,pstats.partition_number <span class="keyword">AS</span> PartitionNumber</span><br><span class="line">	,pstats.row_count <span class="keyword">AS</span> PartitionRowCount</span><br><span class="line">	,p.data_compression_desc <span class="keyword">AS</span> DataCompression</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_db_partition_stats <span class="keyword">AS</span> pstats</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.partitions <span class="keyword">AS</span> p <span class="keyword">ON</span> pstats.partition_id = p.partition_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.destination_data_spaces <span class="keyword">AS</span> dds <span class="keyword">ON</span> pstats.partition_number = dds.destination_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.data_spaces <span class="keyword">AS</span> ds <span class="keyword">ON</span> dds.data_space_id = ds.data_space_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.partition_schemes <span class="keyword">AS</span> ps <span class="keyword">ON</span> dds.partition_scheme_id = ps.data_space_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.partition_functions <span class="keyword">AS</span> pf <span class="keyword">ON</span> ps.function_id = pf.function_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.indexes <span class="keyword">AS</span> i <span class="keyword">ON</span> pstats.object_id = i.object_id </span><br><span class="line"><span class="keyword">AND</span> pstats.index_id = i.index_id </span><br><span class="line"><span class="keyword">AND</span> dds.partition_scheme_id = i.data_space_id </span><br><span class="line"><span class="keyword">AND</span> i.type &lt;= <span class="number">1</span> <span class="comment">/* Heap or Clustered Index */</span></span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.index_columns <span class="keyword">AS</span> ic <span class="keyword">ON</span> i.index_id = ic.index_id </span><br><span class="line"><span class="keyword">AND</span> i.object_id = ic.object_id <span class="keyword">AND</span> ic.partition_ordinal &gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> sys.columns <span class="keyword">AS</span> c <span class="keyword">ON</span> pstats.object_id = c.object_id </span><br><span class="line"><span class="keyword">AND</span> ic.column_id = c.column_id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> sys.partition_range_values <span class="keyword">AS</span> prv <span class="keyword">ON</span> pf.function_id = prv.function_id </span><br><span class="line"><span class="keyword">AND</span> pstats.partition_number = </span><br><span class="line">(<span class="keyword">CASE</span> pf.boundary_value_on_right <span class="keyword">WHEN</span> <span class="number">0</span> <span class="keyword">THEN</span> prv.boundary_id <span class="keyword">ELSE</span> (prv.boundary_id+<span class="number">1</span>) <span class="keyword">END</span>)</span><br><span class="line"><span class="keyword">WHERE</span> pstats.object_id = OBJECT_ID(<span class="string">&#x27;Sales&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> TableName, PartitionNumber;</span><br></pre></td></tr></table></figure>

<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/SQLServerTablePartitioningCheatSheet.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/SQLServerTablePartitioningCheatSheet-200x172.png" alt="SQL Server Table Partitioning Cheat Sheet"></a></p>
<p>The partition function defines how to partition a table based on the values in the partition column. The partitioned table is created on the partition scheme that uses the partition function to map the logical partitions to physical filegroups.</p>
<p>If each partition is mapped to a separate filegroup, partitions can be placed on slower or faster disks based on how frequently they are accessed, historical partitions can be set to read-only, and partitions can be backed up and restored individually based on how critical the data is.</p>
<p>This post is the first in a series of <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/series/table-partitioning-in-sql-server/">Table Partitioning in SQL Server</a> blog posts. It covers the <em>basics</em> of partitioned tables, partition columns, partition functions and partition schemes. Future blog posts in this series will build upon this information and these examples to explain other and more advanced concepts.</p>
<h2 id="Table-Partitioning-Partition-Switching"><a href="#Table-Partitioning-Partition-Switching" class="headerlink" title="Table Partitioning - Partition Switching"></a><em>Table Partitioning - Partition Switching</em></h2><p>This post is part 2 of 2 in the series <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/series/table-partitioning-in-sql-server/">Table Partitioning in SQL Server</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitching.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitching.png" alt="Partition Switching"></a></p>
<p>Inserts, updates and deletes on large tables can be very slow and expensive, cause locking and blocking, and even fill up the transaction log. One of the main benefits of table partitioning is that you can speed up loading and archiving of data by using <em>partition switching</em>.</p>
<p>Partition switching moves entire partitions between tables almost instantly. It is extremely fast because it is a metadata-only operation that updates the location of the data, no data is physically moved. New data can be loaded to separate tables and then <em>switched in</em>, old data can be <em>switched out</em> to separate tables and then archived or purged. All data preparation and manipulation can be done in separate tables without affecting the partitioned table.</p>
<h2 id="Partition-Switching-Requirements"><a href="#Partition-Switching-Requirements" class="headerlink" title="Partition Switching Requirements"></a>Partition Switching Requirements</h2><p>There are always two tables involved in partition switching. Data is switched <em>from</em> a source table <em>to</em> a target table. The target table (or target partition) must always be empty.</p>
<p>(The first time I heard about partition switching, I thought it meant “<em>partition swapping</em>“. I thought it was possible to <em>swap</em> two partitions that both contained data. This is currently not possible, but I hope it will change in a future SQL Server version.)</p>
<p>Partition switching is easy – as long as the source and target tables meet <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/sql/sql-server-2008-r2/ms191160(v=sql.105)">all the requirements</a> :) There are many requirements, but the most important to remember are:</p>
<ul>
<li>The source and target tables (or partitions) must have <em>identical</em> columns, indexes and use the same partition column</li>
<li>The source and target tables (or partitions) must exist on the <em>same filegroup</em></li>
<li>The target table (or partition) must be <em>empty</em></li>
</ul>
<p>If all the requirements are not met, SQL Server is happy to tell you exactly what went wrong and provides detailed and informative error messages. Some of the most common examples are listed near the end of this blog post.</p>
<h2 id="Partition-Switching-Examples"><a href="#Partition-Switching-Examples" class="headerlink" title="Partition Switching Examples"></a>Partition Switching Examples</h2><p>Partitions are switched by using the ALTER TABLE SWITCH statement. You ALTER the source table (or partition) and SWITCH to the target table (or partition). There are four ways to use the ALTER TABLE SWITCH statement:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/2015/04/19/table-partitioning-in-sql-server-partition-switching/#switch1">Switch from a non-partitioned table to another non-partitioned table</a></li>
<li><strong>Load data by switching in:</strong> <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/2015/04/19/table-partitioning-in-sql-server-partition-switching/#switch2">Switch from a non-partitioned table to a partition in a partitioned table</a></li>
<li><strong>Archive data by switching out:</strong> <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/2015/04/19/table-partitioning-in-sql-server-partition-switching/#switch3">Switch from a partition in a partitioned table to a non-partitioned table</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/2015/04/19/table-partitioning-in-sql-server-partition-switching/#switch4">Switch from a partition in a partitioned table to a partition in another partitioned table</a></li>
</ol>
<p>The following examples use code from the previous <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/2015/04/12/table-partitioning-in-sql-server/">Table Partitioning Basics</a> blog post. It is important to notice that these examples are meant to demonstrate the different ways of switching partitions, they do not create any indexes and they map all partitions to the [PRIMARY] filegroup. These examples are not meant to be used in real-world projects.</p>
<h2 id="1-Switch-from-Non-Partitioned-to-Non-Partitioned"><a href="#1-Switch-from-Non-Partitioned-to-Non-Partitioned" class="headerlink" title="1. Switch from Non-Partitioned to Non-Partitioned"></a>1. Switch from Non-Partitioned to Non-Partitioned</h2><p>The first way to use the ALTER TABLE SWITCH statement is to switch all the data from a non-partitioned table to an empty non-partitioned table:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">Source</span> <span class="keyword">SWITCH</span> <span class="keyword">TO</span> Target</span><br></pre></td></tr></table></figure>

<p>Before switch:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch01.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch01-500x225.png" alt="Partition Switch: Non-Partitioned to Non-Partitioned (Before)"></a></p>
<p>After switch:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch02.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch02-500x225.png" alt="Partition Switch: Non-Partitioned to Non-Partitioned (After)"></a></p>
<p>This is probably not used a lot, but it is a great way to start learning the ALTER TABLE SWITCH statement without having to create partition functions and partition schemes:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> – <span class="keyword">Drop</span> objects <span class="keyword">if</span> they already exist</span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.tables <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;SalesSource&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">TABLE</span> SalesSource;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.tables <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;SalesTarget&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">TABLE</span> SalesTarget;</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Create</span> the Non-Partitioned <span class="keyword">Source</span> <span class="keyword">Table</span> (<span class="keyword">Heap</span>) <span class="keyword">on</span> the [PRIMARY] filegroup</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> SalesSource (</span><br><span class="line">  SalesDate <span class="built_in">DATE</span>,</span><br><span class="line">  Quantity <span class="built_in">INT</span></span><br><span class="line">) <span class="keyword">ON</span> [PRIMARY];</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Insert</span> <span class="keyword">test</span> <span class="keyword">data</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> SalesSource(SalesDate, Quantity)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DATEADD</span>(<span class="keyword">DAY</span>,dates.n<span class="number">-1</span>,<span class="string">&#x27;2012-01-01&#x27;</span>) <span class="keyword">AS</span> SalesDate, qty.n <span class="keyword">AS</span> Quantity</span><br><span class="line"><span class="keyword">FROM</span> GetNums(<span class="keyword">DATEDIFF</span>(DD,<span class="string">&#x27;2012-01-01&#x27;</span>,<span class="string">&#x27;2016-01-01&#x27;</span>)) dates</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span> GetNums(<span class="number">1000</span>) <span class="keyword">AS</span> qty;</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Create</span> the Non-Partitioned Target <span class="keyword">Table</span> (<span class="keyword">Heap</span>) <span class="keyword">on</span> the [PRIMARY] filegroup</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> SalesTarget (</span><br><span class="line">  SalesDate <span class="built_in">DATE</span>,</span><br><span class="line">  Quantity <span class="built_in">INT</span></span><br><span class="line">) <span class="keyword">ON</span> [PRIMARY];</span><br><span class="line"></span><br><span class="line"> – Verify row count before switch</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> SalesSource; – 1461000 rows</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> SalesTarget; – 0 rows</span><br><span class="line"></span><br><span class="line"> – Turn on statistics</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">STATISTICS</span> <span class="built_in">TIME</span> <span class="keyword">ON</span>;</span><br><span class="line"></span><br><span class="line"> – Is it really that fast...?</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> SalesSource <span class="keyword">SWITCH</span> <span class="keyword">TO</span> SalesTarget; </span><br><span class="line"> – YEP! SUPER FAST!</span><br><span class="line"></span><br><span class="line"> – Turn off statistics</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">STATISTICS</span> <span class="built_in">TIME</span> <span class="keyword">OFF</span>;</span><br><span class="line"></span><br><span class="line"> – Verify row count after switch</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> SalesSource; – 0 rows</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> SalesTarget; – 1461000 rows</span><br><span class="line"></span><br><span class="line"> – If we try to switch again we will get an error:</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> SalesSource <span class="keyword">SWITCH</span> <span class="keyword">TO</span> SalesTarget; </span><br><span class="line"> – Msg 4905, <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">SWITCH</span> <span class="keyword">statement</span> failed. The target <span class="keyword">table</span> <span class="string">&#x27;SalesTarget&#x27;</span> must be empty.</span><br><span class="line"></span><br><span class="line"> – But <span class="keyword">if</span> we try <span class="keyword">to</span> <span class="keyword">switch</span> back <span class="keyword">to</span> the <span class="keyword">now</span> <span class="keyword">empty</span> <span class="keyword">Source</span> <span class="keyword">table</span>, it works:</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> SalesTarget <span class="keyword">SWITCH</span> <span class="keyword">TO</span> SalesSource; </span><br><span class="line"> – (...STILL SUPER FAST!)</span><br></pre></td></tr></table></figure>

<h2 id="2-Load-data-by-switching-in-Switch-from-Non-Partitioned-to-Partition"><a href="#2-Load-data-by-switching-in-Switch-from-Non-Partitioned-to-Partition" class="headerlink" title="2. Load data by switching in: Switch from Non-Partitioned to Partition"></a>2. Load data by switching in: Switch from Non-Partitioned to Partition</h2><p>The second way to use the ALTER TABLE SWITCH statement is to switch all the data from a non-partitioned table to an empty specified partition in a partitioned table:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">Source</span> <span class="keyword">SWITCH</span> <span class="keyword">TO</span> Target <span class="keyword">PARTITION</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>Before switch:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch03.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch03-500x225.png" alt="Partition Switch: Non-Partitioned to Partition (Before)"></a></p>
<p>After switch:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch04.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch04-500x225.png" alt="Partition Switch: Non-Partitioned to Partition (After)"></a></p>
<p>This is usually referred to as <strong>switching in to load data</strong> into partitioned tables. The non-partitioned table must specify WITH CHECK constraints to ensure that the data can be switched into the specified partition:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"> – <span class="keyword">Drop</span> objects <span class="keyword">if</span> they already exist</span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.tables <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;SalesSource&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">TABLE</span> SalesSource;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.tables <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;SalesTarget&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">TABLE</span> SalesTarget;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.partition_schemes <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;psSales&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> SCHEME psSales;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.partition_functions <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;pfSales&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> <span class="keyword">FUNCTION</span> pfSales;</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Create</span> the <span class="keyword">Partition</span> <span class="keyword">Function</span> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PARTITION</span> <span class="keyword">FUNCTION</span> pfSales (<span class="built_in">DATE</span>)</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">RANGE</span> <span class="keyword">RIGHT</span> <span class="keyword">FOR</span> <span class="keyword">VALUES</span> </span><br><span class="line">(<span class="string">&#x27;2013-01-01&#x27;</span>, <span class="string">&#x27;2014-01-01&#x27;</span>, <span class="string">&#x27;2015-01-01&#x27;</span>);</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Create</span> the <span class="keyword">Partition</span> Scheme</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PARTITION</span> SCHEME psSales</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">PARTITION</span> pfSales </span><br><span class="line"><span class="keyword">ALL</span> <span class="keyword">TO</span> ([Primary]);</span><br><span class="line"></span><br><span class="line"> – <span class="keyword">Create</span> the Non-Partitioned <span class="keyword">Source</span> <span class="keyword">Table</span> (<span class="keyword">Heap</span>) <span class="keyword">on</span> the [PRIMARY] filegroup</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> SalesSource (</span><br><span class="line">  SalesDate <span class="built_in">DATE</span>,</span><br><span class="line">  Quantity <span class="built_in">INT</span></span><br><span class="line">) <span class="keyword">ON</span> [PRIMARY];</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Insert</span> <span class="keyword">test</span> <span class="keyword">data</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> SalesSource(SalesDate, Quantity)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DATEADD</span>(<span class="keyword">DAY</span>,dates.n<span class="number">-1</span>,<span class="string">&#x27;2012-01-01&#x27;</span>) <span class="keyword">AS</span> SalesDate, qty.n <span class="keyword">AS</span> Quantity</span><br><span class="line"><span class="keyword">FROM</span> GetNums(<span class="keyword">DATEDIFF</span>(DD,<span class="string">&#x27;2012-01-01&#x27;</span>,<span class="string">&#x27;2013-01-01&#x27;</span>)) dates</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span> GetNums(<span class="number">1000</span>) <span class="keyword">AS</span> qty;</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Create</span> the Partitioned Target <span class="keyword">Table</span> (<span class="keyword">Heap</span>) <span class="keyword">on</span> the <span class="keyword">Partition</span> Scheme</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> SalesTarget (</span><br><span class="line">  SalesDate <span class="built_in">DATE</span>,</span><br><span class="line">  Quantity <span class="built_in">INT</span></span><br><span class="line">) <span class="keyword">ON</span> psSales(SalesDate);</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Insert</span> <span class="keyword">test</span> <span class="keyword">data</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> SalesTarget(SalesDate, Quantity)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DATEADD</span>(<span class="keyword">DAY</span>,dates.n<span class="number">-1</span>,<span class="string">&#x27;2013-01-01&#x27;</span>) <span class="keyword">AS</span> SalesDate, qty.n <span class="keyword">AS</span> Quantity</span><br><span class="line"><span class="keyword">FROM</span> GetNums(<span class="keyword">DATEDIFF</span>(DD,<span class="string">&#x27;2013-01-01&#x27;</span>,<span class="string">&#x27;2016-01-01&#x27;</span>)) dates</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span> GetNums(<span class="number">1000</span>) <span class="keyword">AS</span> qty;</span><br><span class="line"></span><br><span class="line"> – Verify row count before switch</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> SalesSource; – 366000 rows</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	pstats.partition_number <span class="keyword">AS</span> PartitionNumber</span><br><span class="line">	,pstats.row_count <span class="keyword">AS</span> PartitionRowCount</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_db_partition_stats <span class="keyword">AS</span> pstats</span><br><span class="line"><span class="keyword">WHERE</span> pstats.object_id = OBJECT_ID(<span class="string">&#x27;SalesTarget&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> PartitionNumber; – 0 rows in Partition 1, 365000 rows in Partitions 2-4</span><br><span class="line"></span><br><span class="line"> – Turn on statistics</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">STATISTICS</span> <span class="built_in">TIME</span> <span class="keyword">ON</span>;</span><br><span class="line"></span><br><span class="line"> – Is it really that fast...?</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> SalesSource <span class="keyword">SWITCH</span> <span class="keyword">TO</span> SalesTarget <span class="keyword">PARTITION</span> <span class="number">1</span>; </span><br><span class="line"> – NOPE! We get an error:</span><br><span class="line"> – Msg 4982, <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">SWITCH</span> <span class="keyword">statement</span> failed. <span class="keyword">Check</span> <span class="keyword">constraints</span> <span class="keyword">of</span> <span class="keyword">source</span> <span class="keyword">table</span> <span class="string">&#x27;SalesSource&#x27;</span> </span><br><span class="line"> – <span class="keyword">allow</span> <span class="keyword">values</span> that <span class="keyword">are</span> <span class="keyword">not</span> allowed <span class="keyword">by</span> <span class="keyword">range</span> defined <span class="keyword">by</span> <span class="keyword">partition</span> <span class="number">1</span> <span class="keyword">on</span> target <span class="keyword">table</span> <span class="string">&#x27;Sales&#x27;</span>.</span><br><span class="line"></span><br><span class="line"> – <span class="keyword">Add</span> <span class="keyword">constraints</span> <span class="keyword">to</span> the <span class="keyword">source</span> <span class="keyword">table</span> <span class="keyword">to</span> ensure it <span class="keyword">only</span> contains <span class="keyword">data</span> <span class="keyword">with</span> <span class="keyword">values</span> </span><br><span class="line"> – that <span class="keyword">are</span> allowed <span class="keyword">in</span> <span class="keyword">partition</span> <span class="number">1</span> <span class="keyword">on</span> the target <span class="keyword">table</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> SalesSource</span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">CHECK</span> <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> ckMinSalesDate </span><br><span class="line"><span class="keyword">CHECK</span> (SalesDate <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> SalesDate &gt;= <span class="string">&#x27;2012-01-01&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> SalesSource</span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">CHECK</span> <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> ckMaxSalesDate </span><br><span class="line"><span class="keyword">CHECK</span> (SalesDate <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> SalesDate &lt; <span class="string">&#x27;2013-01-01&#x27;</span>);</span><br><span class="line"></span><br><span class="line"> – Try again. Is it really that fast...?</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> SalesSource <span class="keyword">SWITCH</span> <span class="keyword">TO</span> SalesTarget <span class="keyword">PARTITION</span> <span class="number">1</span>; </span><br><span class="line"> – YEP! SUPER FAST!</span><br><span class="line"></span><br><span class="line"> – Turn off statistics</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">STATISTICS</span> <span class="built_in">TIME</span> <span class="keyword">OFF</span>;</span><br><span class="line"></span><br><span class="line"> – Verify row count after switch</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> SalesSource; – 0 rows</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	pstats.partition_number <span class="keyword">AS</span> PartitionNumber</span><br><span class="line">	,pstats.row_count <span class="keyword">AS</span> PartitionRowCount</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_db_partition_stats <span class="keyword">AS</span> pstats</span><br><span class="line"><span class="keyword">WHERE</span> pstats.object_id = OBJECT_ID(<span class="string">&#x27;SalesTarget&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> PartitionNumber; – 366000 rows in Partition 1, 365000 rows in Partitions 2-4</span><br></pre></td></tr></table></figure>

<h2 id="3-Archive-data-by-switching-out-Switch-from-Partition-to-Non-Partitioned"><a href="#3-Archive-data-by-switching-out-Switch-from-Partition-to-Non-Partitioned" class="headerlink" title="3. Archive data by switching out: Switch from Partition to Non-Partitioned"></a>3. Archive data by switching out: Switch from Partition to Non-Partitioned</h2><p>The third way to use the ALTER TABLE SWITCH statement is to switch all the data from a specified partition in a partitioned table to an empty non-partitioned table:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">Source</span> <span class="keyword">SWITCH</span> <span class="keyword">PARTITION</span> <span class="number">1</span> <span class="keyword">TO</span> Target</span><br></pre></td></tr></table></figure>

<p>Before switch:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch05.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch05-500x225.png" alt="Partition Switch: Partition to Non-Partitioned (Before)"></a></p>
<p>After switch:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch06.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch06-500x225.png" alt="Partition Switch: Partition to Non-Partitioned (After)"></a></p>
<p>This is usually referred to as <strong>switching out to archive data</strong> from partitioned tables:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"> – <span class="keyword">Drop</span> objects <span class="keyword">if</span> they already exist</span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.tables <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;SalesSource&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">TABLE</span> SalesSource;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.tables <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;SalesTarget&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">TABLE</span> SalesTarget;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.partition_schemes <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;psSales&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> SCHEME psSales;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.partition_functions <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;pfSales&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> <span class="keyword">FUNCTION</span> pfSales;</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Create</span> the <span class="keyword">Partition</span> <span class="keyword">Function</span> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PARTITION</span> <span class="keyword">FUNCTION</span> pfSales (<span class="built_in">DATE</span>)</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">RANGE</span> <span class="keyword">RIGHT</span> <span class="keyword">FOR</span> <span class="keyword">VALUES</span> </span><br><span class="line">(<span class="string">&#x27;2013-01-01&#x27;</span>, <span class="string">&#x27;2014-01-01&#x27;</span>, <span class="string">&#x27;2015-01-01&#x27;</span>);</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Create</span> the <span class="keyword">Partition</span> Scheme</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PARTITION</span> SCHEME psSales</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">PARTITION</span> pfSales </span><br><span class="line"><span class="keyword">ALL</span> <span class="keyword">TO</span> ([Primary]);</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Create</span> the Partitioned <span class="keyword">Source</span> <span class="keyword">Table</span> (<span class="keyword">Heap</span>) <span class="keyword">on</span> the <span class="keyword">Partition</span> Scheme</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> SalesSource (</span><br><span class="line">  SalesDate <span class="built_in">DATE</span>,</span><br><span class="line">  Quantity <span class="built_in">INT</span></span><br><span class="line">) <span class="keyword">ON</span> psSales(SalesDate);</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Insert</span> <span class="keyword">test</span> <span class="keyword">data</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> SalesSource(SalesDate, Quantity)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DATEADD</span>(<span class="keyword">DAY</span>,dates.n<span class="number">-1</span>,<span class="string">&#x27;2012-01-01&#x27;</span>) <span class="keyword">AS</span> SalesDate, qty.n <span class="keyword">AS</span> Quantity</span><br><span class="line"><span class="keyword">FROM</span> GetNums(<span class="keyword">DATEDIFF</span>(DD,<span class="string">&#x27;2012-01-01&#x27;</span>,<span class="string">&#x27;2016-01-01&#x27;</span>)) dates</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span> GetNums(<span class="number">1000</span>) <span class="keyword">AS</span> qty;</span><br><span class="line"></span><br><span class="line"> – <span class="keyword">Create</span> the Non-Partitioned Target <span class="keyword">Table</span> (<span class="keyword">Heap</span>) <span class="keyword">on</span> the [PRIMARY] filegroup</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> SalesTarget (</span><br><span class="line">  SalesDate <span class="built_in">DATE</span>,</span><br><span class="line">  Quantity <span class="built_in">INT</span></span><br><span class="line">) <span class="keyword">ON</span> [PRIMARY];</span><br><span class="line"></span><br><span class="line"> – Verify row count before switch</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	pstats.partition_number <span class="keyword">AS</span> PartitionNumber</span><br><span class="line">	,pstats.row_count <span class="keyword">AS</span> PartitionRowCount</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_db_partition_stats <span class="keyword">AS</span> pstats</span><br><span class="line"><span class="keyword">WHERE</span> pstats.object_id = OBJECT_ID(<span class="string">&#x27;Sales&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> PartitionNumber; – 366000 rows in Partition 1, 365000 rows in Partitions 2-4</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> SalesTarget; – 0 rows</span><br><span class="line"></span><br><span class="line"> – Turn on statistics</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">STATISTICS</span> <span class="built_in">TIME</span> <span class="keyword">ON</span>;</span><br><span class="line"></span><br><span class="line"> – Is it really that fast...?</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> SalesSource <span class="keyword">SWITCH</span> <span class="keyword">PARTITION</span> <span class="number">1</span> <span class="keyword">TO</span> SalesTarget; </span><br><span class="line"> – YEP! SUPER FAST!</span><br><span class="line"></span><br><span class="line"> – Turn off statistics</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">STATISTICS</span> <span class="built_in">TIME</span> <span class="keyword">OFF</span>;</span><br><span class="line"></span><br><span class="line"> – Verify row count after switch</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	pstats.partition_number <span class="keyword">AS</span> PartitionNumber</span><br><span class="line">	,pstats.row_count <span class="keyword">AS</span> PartitionRowCount</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_db_partition_stats <span class="keyword">AS</span> pstats</span><br><span class="line"><span class="keyword">WHERE</span> pstats.object_id = OBJECT_ID(<span class="string">&#x27;SalesSource&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> PartitionNumber; – 0 rows in Partition 1, 365000 rows in Partitions 2-4</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> SalesTarget; – 366000 rows</span><br></pre></td></tr></table></figure>

<h2 id="4-Switch-from-Partition-to-Partition"><a href="#4-Switch-from-Partition-to-Partition" class="headerlink" title="4. Switch from Partition to Partition"></a>4. Switch from Partition to Partition</h2><p>The fourth way to use the ALTER TABLE SWITCH statement is to switch all the data from a specified partition in a partitioned table to an empty specified partition in another partitioned table:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">Source</span> <span class="keyword">SWITCH</span> <span class="keyword">PARTITION</span> <span class="number">1</span> <span class="keyword">TO</span> Target <span class="keyword">PARTITION</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>Before switch:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch07.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch07-500x225.png" alt="Partition Switch: Partition to Partition (Before)"></a></p>
<p>After switch:</p>
<p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch08.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitch08-500x225.png" alt="Partition Switch: Partition to Partition (After)"></a></p>
<p>This can be used when data needs to be archived in another partitioned table:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"> – <span class="keyword">Drop</span> objects <span class="keyword">if</span> they already exist</span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.tables <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;SalesSource&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">TABLE</span> SalesSource;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.tables <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;SalesTarget&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">TABLE</span> SalesTarget;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.partition_schemes <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;psSales&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> SCHEME psSales;</span><br><span class="line">IF EXISTS (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> sys.partition_functions <span class="keyword">WHERE</span> <span class="keyword">name</span> = N<span class="string">&#x27;pfSales&#x27;</span>)</span><br><span class="line">  <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> <span class="keyword">FUNCTION</span> pfSales;</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Create</span> the <span class="keyword">Partition</span> <span class="keyword">Function</span> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PARTITION</span> <span class="keyword">FUNCTION</span> pfSales (<span class="built_in">DATE</span>)</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">RANGE</span> <span class="keyword">RIGHT</span> <span class="keyword">FOR</span> <span class="keyword">VALUES</span> </span><br><span class="line">(<span class="string">&#x27;2013-01-01&#x27;</span>, <span class="string">&#x27;2014-01-01&#x27;</span>, <span class="string">&#x27;2015-01-01&#x27;</span>);</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Create</span> the <span class="keyword">Partition</span> Scheme</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PARTITION</span> SCHEME psSales</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">PARTITION</span> pfSales </span><br><span class="line"><span class="keyword">ALL</span> <span class="keyword">TO</span> ([Primary]);</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Create</span> the Partitioned <span class="keyword">Source</span> <span class="keyword">Table</span> (<span class="keyword">Heap</span>) <span class="keyword">on</span> the <span class="keyword">Partition</span> Scheme</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> SalesSource (</span><br><span class="line">  SalesDate <span class="built_in">DATE</span>,</span><br><span class="line">  Quantity <span class="built_in">INT</span></span><br><span class="line">) <span class="keyword">ON</span> psSales(SalesDate);</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Insert</span> <span class="keyword">test</span> <span class="keyword">data</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> SalesSource(SalesDate, Quantity)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DATEADD</span>(<span class="keyword">DAY</span>,dates.n<span class="number">-1</span>,<span class="string">&#x27;2012-01-01&#x27;</span>) <span class="keyword">AS</span> SalesDate, qty.n <span class="keyword">AS</span> Quantity</span><br><span class="line"><span class="keyword">FROM</span> GetNums(<span class="keyword">DATEDIFF</span>(DD,<span class="string">&#x27;2012-01-01&#x27;</span>,<span class="string">&#x27;2013-01-01&#x27;</span>)) dates</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span> GetNums(<span class="number">1000</span>) <span class="keyword">AS</span> qty;</span><br><span class="line"></span><br><span class="line"> – <span class="keyword">Create</span> the Partitioned Target <span class="keyword">Table</span> (<span class="keyword">Heap</span>) <span class="keyword">on</span> the <span class="keyword">Partition</span> Scheme</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> SalesTarget (</span><br><span class="line">  SalesDate <span class="built_in">DATE</span>,</span><br><span class="line">  Quantity <span class="built_in">INT</span></span><br><span class="line">) <span class="keyword">ON</span> psSales(SalesDate);</span><br><span class="line"> </span><br><span class="line"> – <span class="keyword">Insert</span> <span class="keyword">test</span> <span class="keyword">data</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> SalesTarget(SalesDate, Quantity)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DATEADD</span>(<span class="keyword">DAY</span>,dates.n<span class="number">-1</span>,<span class="string">&#x27;2013-01-01&#x27;</span>) <span class="keyword">AS</span> SalesDate, qty.n <span class="keyword">AS</span> Quantity</span><br><span class="line"><span class="keyword">FROM</span> GetNums(<span class="keyword">DATEDIFF</span>(DD,<span class="string">&#x27;2013-01-01&#x27;</span>,<span class="string">&#x27;2016-01-01&#x27;</span>)) dates</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span> GetNums(<span class="number">1000</span>) <span class="keyword">AS</span> qty;</span><br><span class="line"></span><br><span class="line"> – Verify row count before switch</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	pstats.partition_number <span class="keyword">AS</span> PartitionNumber</span><br><span class="line">	,pstats.row_count <span class="keyword">AS</span> PartitionRowCount</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_db_partition_stats <span class="keyword">AS</span> pstats</span><br><span class="line"><span class="keyword">WHERE</span> pstats.object_id = OBJECT_ID(<span class="string">&#x27;SalesSource&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> PartitionNumber; – 366000 rows in Partition 1, 0 rows in Partitions 2-4</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	pstats.partition_number <span class="keyword">AS</span> PartitionNumber</span><br><span class="line">	,pstats.row_count <span class="keyword">AS</span> PartitionRowCount</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_db_partition_stats <span class="keyword">AS</span> pstats</span><br><span class="line"><span class="keyword">WHERE</span> pstats.object_id = OBJECT_ID(<span class="string">&#x27;SalesTarget&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> PartitionNumber; – 0 rows in Partition 1, 365000 rows in Partitions 2-4</span><br><span class="line"></span><br><span class="line"> – Turn on statistics</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">STATISTICS</span> <span class="built_in">TIME</span> <span class="keyword">ON</span>;</span><br><span class="line"></span><br><span class="line"> – Is it really that fast...?</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> SalesSource <span class="keyword">SWITCH</span> <span class="keyword">PARTITION</span> <span class="number">1</span> <span class="keyword">TO</span> SalesTarget <span class="keyword">PARTITION</span> <span class="number">1</span>; </span><br><span class="line"> – YEP! SUPER FAST!</span><br><span class="line"></span><br><span class="line"> – Turn off statistics</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">STATISTICS</span> <span class="built_in">TIME</span> <span class="keyword">OFF</span>;</span><br><span class="line"></span><br><span class="line"> – Verify row count after switch</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	pstats.partition_number <span class="keyword">AS</span> PartitionNumber</span><br><span class="line">	,pstats.row_count <span class="keyword">AS</span> PartitionRowCount</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_db_partition_stats <span class="keyword">AS</span> pstats</span><br><span class="line"><span class="keyword">WHERE</span> pstats.object_id = OBJECT_ID(<span class="string">&#x27;SalesSource&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> PartitionNumber; – 0 rows in Partition 1-4</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	pstats.partition_number <span class="keyword">AS</span> PartitionNumber</span><br><span class="line">	,pstats.row_count <span class="keyword">AS</span> PartitionRowCount</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_db_partition_stats <span class="keyword">AS</span> pstats</span><br><span class="line"><span class="keyword">WHERE</span> pstats.object_id = OBJECT_ID(<span class="string">&#x27;SalesTarget&#x27;</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> PartitionNumber; – 366000 rows in Partition 1, 365000 rows in Partitions 2-4</span><br></pre></td></tr></table></figure>

<h2 id="Error-messages"><a href="#Error-messages" class="headerlink" title="Error messages"></a>Error messages</h2><p>SQL Server provides detailed and informative error messages if not all requirements are met before switching partitions. You can see all messages related to ALTER TABLE SWITCH by executing the following query, it is also quite a handy requirements checklist:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> message_id, <span class="built_in">text</span> </span><br><span class="line"><span class="keyword">FROM</span> sys.messages </span><br><span class="line"><span class="keyword">WHERE</span> language_id = <span class="number">1033</span></span><br><span class="line"><span class="keyword">AND</span> <span class="built_in">text</span> <span class="keyword">LIKE</span> <span class="string">&#x27;%ALTER TABLE SWITCH%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h2><p><a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitching.png"><img src="https://www.cathrinewilhelmsen.net/scribbles/wp-content/uploads/2015/04/PartitionSwitching.png" alt="Partition Switching"></a></p>
<p>Partition switching moves entire partitions between tables almost instantly. New data can be loaded to separate tables and then <em>switched in</em>, old data can be <em>switched out</em> to separate tables and then archived or purged. There are many requirements for switching partitions. It is important to understand and test how partition switching works with filegroups, indexes and constraints.</p>
<p>This post is the second in a series of <a target="_blank" rel="noopener" href="https://www.cathrinewilhelmsen.net/series/table-partitioning-in-sql-server/">Table Partitioning in SQL Server</a> blog posts. It covers the <em>basics</em> of partition switching. Future blog posts in this series will build upon this information and these examples to explain other and more advanced concepts.</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/SQL-Server/">SQL Server</a><a class="link-muted mr-2" rel="tag" href="/tags/partitioning/">partitioning</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/12/26/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-2/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">SQL Server Table Partitioning in Large Scale Data Warehouse 2</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/12/22/Hadoop-Data-Side-Load-from-SQL-Server/"><span class="level-item">Hadoop Data Side Load from SQL Server</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://hermanteng19.github.io/2020/12/25/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-1/';
            this.page.identifier = '2020/12/25/SQL-Server-Table-Partitioning-in-Large-Scale-Data-Warehouse-1/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'herman-hexo-blog' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar1.png" alt="Herman"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Herman</p><p class="is-size-6 is-block">Data Analyst&amp;Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Toronto, Canada</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">27</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">76</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/HermanTeng19" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/HermanTeng19"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Table-Partitioning-The-Basics"><span class="level-left"><span class="level-item">1</span><span class="level-item">Table Partitioning The Basics</span></span></a></li><li><a class="level is-mobile" href="#What-is-Table-Partitioning"><span class="level-left"><span class="level-item">2</span><span class="level-item">What is Table Partitioning?</span></span></a></li><li><a class="level is-mobile" href="#What-is-a-Partition-Column"><span class="level-left"><span class="level-item">3</span><span class="level-item">What is a Partition Column?</span></span></a></li><li><a class="level is-mobile" href="#What-is-a-Partition-Function"><span class="level-left"><span class="level-item">4</span><span class="level-item">What is a Partition Function?</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Range-Left-and-Range-Right"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">Range Left and Range Right</span></span></a></li><li><a class="level is-mobile" href="#Range-Left-and-Range-Right-using-Dates"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">Range Left and Range Right using Dates</span></span></a></li><li><a class="level is-mobile" href="#Range-Left-and-Range-Right-using-the-Wrong-Dates"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">Range Left and Range Right using the Wrong Dates</span></span></a></li></ul></li><li><a class="level is-mobile" href="#What-is-a-Partition-Scheme"><span class="level-left"><span class="level-item">5</span><span class="level-item">What is a Partition Scheme?</span></span></a></li><li><a class="level is-mobile" href="#How-do-I-create-a-Partitioned-Table"><span class="level-left"><span class="level-item">6</span><span class="level-item">How do I create a Partitioned Table?</span></span></a></li><li><a class="level is-mobile" href="#Summary"><span class="level-left"><span class="level-item">7</span><span class="level-item">Summary</span></span></a></li><li><a class="level is-mobile" href="#Table-Partitioning-Partition-Switching"><span class="level-left"><span class="level-item">8</span><span class="level-item">Table Partitioning - Partition Switching</span></span></a></li><li><a class="level is-mobile" href="#Partition-Switching-Requirements"><span class="level-left"><span class="level-item">9</span><span class="level-item">Partition Switching Requirements</span></span></a></li><li><a class="level is-mobile" href="#Partition-Switching-Examples"><span class="level-left"><span class="level-item">10</span><span class="level-item">Partition Switching Examples</span></span></a></li><li><a class="level is-mobile" href="#1-Switch-from-Non-Partitioned-to-Non-Partitioned"><span class="level-left"><span class="level-item">11</span><span class="level-item">1. Switch from Non-Partitioned to Non-Partitioned</span></span></a></li><li><a class="level is-mobile" href="#2-Load-data-by-switching-in-Switch-from-Non-Partitioned-to-Partition"><span class="level-left"><span class="level-item">12</span><span class="level-item">2. Load data by switching in: Switch from Non-Partitioned to Partition</span></span></a></li><li><a class="level is-mobile" href="#3-Archive-data-by-switching-out-Switch-from-Partition-to-Non-Partitioned"><span class="level-left"><span class="level-item">13</span><span class="level-item">3. Archive data by switching out: Switch from Partition to Non-Partitioned</span></span></a></li><li><a class="level is-mobile" href="#4-Switch-from-Partition-to-Partition"><span class="level-left"><span class="level-item">14</span><span class="level-item">4. Switch from Partition to Partition</span></span></a></li><li><a class="level is-mobile" href="#Error-messages"><span class="level-left"><span class="level-item">15</span><span class="level-item">Error messages</span></span></a></li><li><a class="level is-mobile" href="#Summary-1"><span class="level-left"><span class="level-item">16</span><span class="level-item">Summary</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatar1.png" alt="Herman-blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 Herman Teng</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>